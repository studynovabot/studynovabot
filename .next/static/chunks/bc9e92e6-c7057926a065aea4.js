"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[992],{7015:(e,t,r)=>{r.d(t,{aU:()=>lt});var n,i,s,a,o=r(2612),l=r(6391),u=r(796),h=r(9887),c=r(2107),d=r(927),f=r(9509),m=r(9641).Buffer;let g="@firebase/firestore",p="4.7.10";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="11.5.0",v=new u.Vy("@firebase/firestore");function I(){return v.logLevel}function T(e,...t){if(v.logLevel<=u.$b.DEBUG){let r=t.map(_);v.debug(`Firestore (${w}): ${e}`,...r)}}function E(e,...t){if(v.logLevel<=u.$b.ERROR){let r=t.map(_);v.error(`Firestore (${w}): ${e}`,...r)}}function b(e,...t){if(v.logLevel<=u.$b.WARN){let r=t.map(_);v.warn(`Firestore (${w}): ${e}`,...r)}}function _(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function S(e="Unexpected state"){let t=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: `+e;throw E(t),Error(t)}let x={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class N extends h.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class D{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class k{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class C{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class A{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class V{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){void 0===this.o||S();let r=this.i,n=e=>this.i!==r?(r=this.i,t(e)):Promise.resolve(),i=new D;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new D,e.enqueueRetryable(()=>n(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await n(this.currentUser)})},a=e=>{T("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(T("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new D)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(T("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?("string"==typeof t.accessToken||S(),new k(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return null===e||"string"==typeof e||S(),new y(e)}}class R{constructor(e,t,r){this.l=e,this.h=t,this.P=r,this.type="FirstParty",this.user=y.FIRST_PARTY,this.T=new Map}I(){return this.P?this.P():null}get headers(){this.T.set("X-Goog-AuthUser",this.l);let e=this.I();return e&&this.T.set("Authorization",e),this.h&&this.T.set("X-Goog-Iam-Authorization-Token",this.h),this.T}}class O{constructor(e,t,r){this.l=e,this.h=t,this.P=r}getToken(){return Promise.resolve(new R(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class M{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e,t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null,this.V=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.V=e.settings.appCheckToken)}start(e,t){void 0===this.o||S();let r=e=>{null!=e.error&&T("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let r=e.token!==this.R;return this.R=e.token,T("FirebaseAppCheckTokenProvider",`Received ${r?"new":"existing"} token.`),r?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>r(t))};let n=e=>{T("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>n(e)),setTimeout(()=>{if(!this.appCheck){let e=this.A.getImmediate({optional:!0});e?n(e):T("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.V)return Promise.resolve(new M(this.V));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?("string"==typeof e.token||S(),this.R=e.token,new M(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}function F(){return new TextEncoder}class P{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let r=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(r);else for(let e=0;e<40;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let n=0;n<r.length;++n)t.length<20&&r[n]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(r[n]%62))}return t}}function U(e,t){return e<t?-1:+(e>t)}function q(e,t){let r=0;for(;r<e.length&&r<t.length;){let n=e.codePointAt(r),i=t.codePointAt(r);if(n!==i){if(n<128&&i<128)return U(n,i);{let s=F(),a=function(e,t){for(let r=0;r<e.length&&r<t.length;++r)if(e[r]!==t[r])return U(e[r],t[r]);return U(e.length,t.length)}(s.encode(B(e,r)),s.encode(B(t,r)));return 0!==a?a:U(n,i)}}r+=n>65535?2:1}return U(e.length,t.length)}function B(e,t){return e.codePointAt(t)>65535?e.substring(t,t+2):e.substring(t,t+1)}function z(e,t,r){return e.length===t.length&&e.every((e,n)=>r(e,t[n]))}class K{static now(){return K.fromMillis(Date.now())}static fromDate(e){return K.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor((e-1e3*t)*1e6);return new K(t,r)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new N(x.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new N(x.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?U(this.nanoseconds,e.nanoseconds):U(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ${static fromTimestamp(e){return new $(e)}static min(){return new $(new K(0,0))}static max(){return new $(new K(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}let G="__name__";class j{constructor(e,t,r){void 0===t?t=0:t>e.length&&S(),void 0===r?r=e.length-t:r>e.length-t&&S(),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return 0===j.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof j?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let n=0;n<r;n++){let r=j.compareSegments(e.get(n),t.get(n));if(0!==r)return r}return U(e.length,t.length)}static compareSegments(e,t){let r=j.isNumericId(e),n=j.isNumericId(t);return r&&!n?-1:!r&&n?1:r&&n?j.extractNumericId(e).compare(j.extractNumericId(t)):q(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return c.jz.fromString(e.substring(4,e.length-2))}}class Q extends j{construct(e,t,r){return new Q(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new N(x.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(e=>e.length>0))}return new Q(t)}static emptyPath(){return new Q([])}}let H=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends j{construct(e,t,r){return new W(e,t,r)}static isValidIdentifier(e){return H.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===G}static keyField(){return new W([G])}static fromServerFormat(e){let t=[],r="",n=0,i=()=>{if(0===r.length)throw new N(x.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},s=!1;for(;n<e.length;){let t=e[n];if("\\"===t){if(n+1===e.length)throw new N(x.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[n+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new N(x.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=t,n+=2}else"`"===t?s=!s:"."!==t||s?r+=t:i(),n++}if(i(),s)throw new N(x.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new W(t)}static emptyPath(){return new W([])}}class Y{constructor(e){this.path=e}static fromPath(e){return new Y(Q.fromString(e))}static fromName(e){return new Y(Q.fromString(e).popFirst(5))}static empty(){return new Y(Q.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Q.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Q.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Y(new Q(e.slice()))}}class Z{constructor(e,t,r,n){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=n}}function J(e){return e.fields.find(e=>2===e.kind)}function X(e){return e.fields.filter(e=>2!==e.kind)}Z.UNKNOWN_ID=-1;class ee{constructor(e,t){this.fieldPath=e,this.kind=t}}class et{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new et(0,ei.min())}}function er(e,t){let r=e.toTimestamp().seconds,n=e.toTimestamp().nanoseconds+1;return new ei($.fromTimestamp(1e9===n?new K(r+1,0):new K(r,n)),Y.empty(),t)}function en(e){return new ei(e.readTime,e.key,-1)}class ei{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new ei($.min(),Y.empty(),-1)}static max(){return new ei($.max(),Y.empty(),-1)}}function es(e,t){let r=e.readTime.compareTo(t.readTime);return 0!==r||0!==(r=Y.comparator(e.documentKey,t.documentKey))?r:U(e.largestBatchId,t.largestBatchId)}let ea="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class eo{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function el(e){if(e.code!==x.FAILED_PRECONDITION||e.message!==ea)throw e;T("LocalStore","Unexpectedly lost primary lease")}class eu{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&S(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new eu((r,n)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(r,n)},this.catchCallback=e=>{this.wrapFailure(t,e).next(r,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof eu?t:eu.resolve(t)}catch(e){return eu.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):eu.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):eu.reject(t)}static resolve(e){return new eu((t,r)=>{t(e)})}static reject(e){return new eu((t,r)=>{r(e)})}static waitFor(e){return new eu((t,r)=>{let n=0,i=0,s=!1;e.forEach(e=>{++n,e.next(()=>{++i,s&&i===n&&t()},e=>r(e))}),s=!0,i===n&&t()})}static or(e){let t=eu.resolve(!1);for(let r of e)t=t.next(e=>e?eu.resolve(e):r());return t}static forEach(e,t){let r=[];return e.forEach((e,n)=>{r.push(t.call(this,e,n))}),this.waitFor(r)}static mapArray(e,t){return new eu((r,n)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&r(s)},e=>n(e))}})}static doWhile(e,t){return new eu((r,n)=>{let i=()=>{!0===e()?t().next(()=>{i()},n):r()};i()})}}let eh="SimpleDb";class ec{static open(e,t,r,n){try{return new ec(t,e.transaction(n,r))}catch(e){throw new eg(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.m=new D,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{t.error?this.m.reject(new eg(e,t.error)):this.m.resolve()},this.transaction.onerror=t=>{let r=eI(t.target.error);this.m.reject(new eg(e,r))}}get p(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(T(eh,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}S(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new ey(this.transaction.objectStore(e))}}class ed{static delete(e){return T(eh,"Removing database:",e),ew(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,h.zW)())return!1;if(ed.v())return!0;let e=(0,h.ZQ)(),t=ed.C(e),r=ef(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<r&&r<4.5)}static v(){var e;return void 0!==f&&"YES"===(null==(e=f.__PRIVATE_env)?void 0:e.F)}static M(e,t){return e.store(t)}static C(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,r){this.name=e,this.version=t,this.O=r,12.2===ed.C((0,h.ZQ)())&&E("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async N(e){return this.db||(T(eh,"Opening database:",this.name),this.db=await new Promise((t,r)=>{let n=indexedDB.open(this.name,this.version);n.onsuccess=e=>{t(e.target.result)},n.onblocked=()=>{r(new eg(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},n.onerror=t=>{let n=t.target.error;"VersionError"===n.name?r(new N(x.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===n.name?r(new N(x.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+n)):r(new eg(e,n))},n.onupgradeneeded=e=>{T(eh,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.O.B(t,n.transaction,e.oldVersion,this.version).next(()=>{T(eh,"Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(e){this.L=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,r,n){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.N(e);let t=ec.open(this.db,e,i?"readonly":"readwrite",r),s=n(t).next(e=>(t.S(),e)).catch(e=>(t.abort(e),eu.reject(e))).toPromise();return s.catch(()=>{}),await t.p,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(T(eh,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ef(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class em{constructor(e){this.q=e,this.$=!1,this.U=null}get isDone(){return this.$}get K(){return this.U}set cursor(e){this.q=e}done(){this.$=!0}W(e){this.U=e}delete(){return ew(this.q.delete())}}class eg extends N{constructor(e,t){super(x.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ep(e){return"IndexedDbTransactionError"===e.name}class ey{constructor(e){this.store=e}put(e,t){let r;return void 0!==t?(T(eh,"PUT",this.store.name,e,t),r=this.store.put(t,e)):(T(eh,"PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),ew(r)}add(e){return T(eh,"ADD",this.store.name,e,e),ew(this.store.add(e))}get(e){return ew(this.store.get(e)).next(t=>(void 0===t&&(t=null),T(eh,"GET",this.store.name,e,t),t))}delete(e){return T(eh,"DELETE",this.store.name,e),ew(this.store.delete(e))}count(){return T(eh,"COUNT",this.store.name),ew(this.store.count())}G(e,t){let r=this.options(e,t),n=r.index?this.store.index(r.index):this.store;if("function"==typeof n.getAll){let e=n.getAll(r.range);return new eu((t,r)=>{e.onerror=e=>{r(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(r),t=[];return this.j(e,(e,r)=>{t.push(r)}).next(()=>t)}}H(e,t){let r=this.store.getAll(e,null===t?void 0:t);return new eu((e,t)=>{r.onerror=e=>{t(e.target.error)},r.onsuccess=t=>{e(t.target.result)}})}J(e,t){T(eh,"DELETE ALL",this.store.name);let r=this.options(e,t);r.Y=!1;let n=this.cursor(r);return this.j(n,(e,t,r)=>r.delete())}Z(e,t){let r;t?r=e:(r={},t=e);let n=this.cursor(r);return this.j(n,t)}X(e){let t=this.cursor({});return new eu((r,n)=>{t.onerror=e=>{n(eI(e.target.error))},t.onsuccess=t=>{let n=t.target.result;n?e(n.primaryKey,n.value).next(e=>{e?n.continue():r()}):r()}})}j(e,t){let r=[];return new eu((n,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void n();let s=new em(i),a=t(i.primaryKey,i.value,s);if(a instanceof eu){let e=a.catch(e=>(s.done(),eu.reject(e)));r.push(e)}s.isDone?n():null===s.K?i.continue():i.continue(s.K)}}).next(()=>eu.waitFor(r))}options(e,t){let r;return void 0!==e&&("string"==typeof e?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let r=this.store.index(e.index);return e.Y?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ew(e){return new eu((t,r)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{r(eI(e.target.error))}})}let ev=!1;function eI(e){let t=ed.C((0,h.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new N("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ev||(ev=!0,setTimeout(()=>{throw e},0)),e}}return e}let eT="IndexBackfiller";class eE{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){T(eT,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ee.ne();T(eT,`Documents written: ${e}`)}catch(e){ep(e)?T(eT,"Ignoring IndexedDB error during index backfill: ",e):await el(e)}await this.te(6e4)})}}class eb{constructor(e,t){this.localStore=e,this.persistence=t}async ne(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.re(t,e))}re(e,t){let r=new Set,n=t,i=!0;return eu.doWhile(()=>!0===i&&n>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!r.has(t))return T(eT,`Processing collection: ${t}`),this.ie(e,t,n).next(e=>{n-=e,r.add(t)});i=!1})).next(()=>t-n)}ie(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(n=>this.localStore.localDocuments.getNextDocuments(e,t,n,r).next(r=>{let i=r.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.se(n,r)).next(r=>(T(eT,`Updating offset: ${r}`),this.localStore.indexManager.updateCollectionGroup(e,t,r))).next(()=>i.size)}))}se(e,t){let r=e;return t.changes.forEach((e,t)=>{let n=en(t);es(n,r)>0&&(r=n)}),new ei(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class e_{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this._e&&this._e(e),e}}function eS(e){return null==e}function ex(e){return 0===e&&1/e==-1/0}function eN(e){return"number"==typeof e&&Number.isInteger(e)&&!ex(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eD(e){let t="";for(let r=0;r<e.length;r++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let r=t,n=e.length;for(let t=0;t<n;t++){let n=e.charAt(t);switch(n){case"\0":r+="\x01\x10";break;case"\x01":r+="\x01\x11";break;default:r+=n}}return r}(e.get(r),t);return t+"\x01\x01"}e_.ae=-1;function ek(e){let t=e.length;if(t>=2||S(),2===t)return"\x01"===e.charAt(0)&&"\x01"===e.charAt(1)||S(),Q.emptyPath();let r=t-2,n=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>r)&&S(),e.charAt(t+1)){case"\x01":let a,o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),n.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:S()}s=t+2}return new Q(n)}let eC="remoteDocuments",eA="owner",eV="owner",eR="mutationQueues",eO="mutations",eM="batchId",eL="userMutationsIndex",eF=["userId","batchId"],eP={},eU="documentMutations",eq="remoteDocumentsV14",eB=["prefixPath","collectionGroup","readTime","documentId"],ez="documentKeyIndex",eK=["prefixPath","collectionGroup","documentId"],e$="collectionGroupIndex",eG=["collectionGroup","readTime","prefixPath","documentId"],ej="remoteDocumentGlobal",eQ="remoteDocumentGlobalKey",eH="targets",eW="queryTargetsIndex",eY=["canonicalId","targetId"],eZ="targetDocuments",eJ=["targetId","path"],eX="documentTargetsIndex",e0=["path","targetId"],e1="targetGlobalKey",e2="targetGlobal",e5="collectionParents",e8=["collectionId","parent"],e3="clientMetadata",e4="bundles",e6="namedQueries",e9="indexConfiguration",e7="collectionGroupIndex",te="indexState",tt=["indexId","uid"],tr="sequenceNumberIndex",tn=["uid","sequenceNumber"],ti="indexEntries",ts=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ta="documentKeyIndex",to=["indexId","uid","orderedDocumentKey"],tl="documentOverlays",tu=["userId","collectionPath","documentId"],th="collectionPathOverlayIndex",tc=["userId","collectionPath","largestBatchId"],td="collectionGroupOverlayIndex",tf=["userId","collectionGroup","largestBatchId"],tm="globals",tg=[eR,eO,eU,eC,eH,eA,e2,eZ,e3,ej,e5,e4,e6],tp=[...tg,tl],ty=[eR,eO,eU,eq,eH,eA,e2,eZ,e3,ej,e5,e4,e6,tl],tw=[...ty,e9,te,ti],tv=[...tw,tm];class tI extends eo{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function tT(e,t){return ed.M(e.ue,t)}function tE(e){let t=0;for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t++;return t}function tb(e,t){for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(r,e[r])}function t_(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tS{constructor(e,t){this.comparator=e,this.root=t||tN.EMPTY}insert(e,t){return new tS(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tN.BLACK,null,null))}remove(e){return new tS(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tN.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(0===r)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let n=this.comparator(e,r.key);if(0===n)return t+r.left.size;n<0?r=r.left:(t+=r.left.size+1,r=r.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tx(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tx(this.root,e,this.comparator,!1)}getReverseIterator(){return new tx(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tx(this.root,e,this.comparator,!0)}}class tx{constructor(e,t,r,n){this.isReverse=n,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?r(e.key,t):1,t&&n&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tN{constructor(e,t,r,n,i){this.key=e,this.value=t,this.color=null!=r?r:tN.RED,this.left=null!=n?n:tN.EMPTY,this.right=null!=i?i:tN.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,n,i){return new tN(null!=e?e:this.key,null!=t?t:this.value,null!=r?r:this.color,null!=n?n:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let n=this,i=r(e,n.key);return(n=i<0?n.copy(null,null,null,n.left.insert(e,t,r),null):0===i?n.copy(null,t,null,null,null):n.copy(null,null,null,null,n.right.insert(e,t,r))).fixUp()}removeMin(){if(this.left.isEmpty())return tN.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let r,n=this;if(0>t(e,n.key))n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(e,t),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),0===t(e,n.key)){if(n.right.isEmpty())return tN.EMPTY;r=n.right.min(),n=n.copy(r.key,r.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(e,t))}return n.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,tN.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,tN.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw S();let e=this.left.check();if(e!==this.right.check())throw S();return e+ +!this.isRed()}}tN.EMPTY=null,tN.RED=!0,tN.BLACK=!1,tN.EMPTY=new class{constructor(){this.size=0}get key(){throw S()}get value(){throw S()}get color(){throw S()}get left(){throw S()}get right(){throw S()}copy(e,t,r,n,i){return this}insert(e,t,r){return new tN(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tD{constructor(e){this.comparator=e,this.data=new tS(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let n=r.getNext();if(this.comparator(n.key,e[1])>=0)return;t(n.key)}}forEachWhile(e,t){let r;for(r=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tk(this.data.getIterator())}getIteratorFrom(e){return new tk(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tD)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,n=r.getNext().key;if(0!==this.comparator(e,n))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tD(this.comparator);return t.data=e,t}}class tk{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tC(e){return e.hasNext()?e.getNext():void 0}class tA{constructor(e){this.fields=e,e.sort(W.comparator)}static empty(){return new tA([])}unionWith(e){let t=new tD(W.comparator);for(let e of this.fields)t=t.add(e);for(let r of e)t=t.add(r);return new tA(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return z(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tV extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class tR{constructor(e){this.binaryString=e}static fromBase64String(e){return new tR(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tV("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tR(function(e){let t="";for(let r=0;r<e.length;++r)t+=String.fromCharCode(e[r]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){var e=this.binaryString;let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return U(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tR.EMPTY_BYTE_STRING=new tR("");let tO=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tM(e){if(e||S(),"string"==typeof e){let t=0,r=tO.exec(e);if(r||S(),r[1]){let e=r[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tL(e.seconds),nanos:tL(e.nanos)}}function tL(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function tF(e){return"string"==typeof e?tR.fromBase64String(e):tR.fromUint8Array(e)}let tP="server_timestamp",tU="__type__",tq="__previous_value__",tB="__local_write_time__";function tz(e){var t,r;return(null==(r=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{})[tU])?void 0:r.stringValue)===tP}function tK(e){let t=e.mapValue.fields[tq];return tz(t)?tK(t):t}function t$(e){let t=tM(e.mapValue.fields[tB].timestampValue);return new K(t.seconds,t.nanos)}class tG{constructor(e,t,r,n,i,s,a,o,l){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=n,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l}}let tj="(default)";class tQ{constructor(e,t){this.projectId=e,this.database=t||tj}static empty(){return new tQ("","")}get isDefaultDatabase(){return this.database===tj}isEqual(e){return e instanceof tQ&&e.projectId===this.projectId&&e.database===this.database}}let tH="__type__",tW="__max__",tY={mapValue:{fields:{__type__:{stringValue:tW}}}},tZ="__vector__",tJ="value",tX={nullValue:"NULL_VALUE"};function t0(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tz(e)?4:rs(e)?0x1fffffffffffff:rn(e)?10:11:S()}function t1(e,t){if(e===t)return!0;let r=t0(e);if(r!==t0(t))return!1;switch(r){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return t$(e).isEqual(t$(t));case 3:if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let n=tM(e.timestampValue),i=tM(t.timestampValue);return n.seconds===i.seconds&&n.nanos===i.nanos;case 5:return e.stringValue===t.stringValue;case 6:return tF(e.bytesValue).isEqual(tF(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tL(e.geoPointValue.latitude)===tL(t.geoPointValue.latitude)&&tL(e.geoPointValue.longitude)===tL(t.geoPointValue.longitude);case 2:if("integerValue"in e&&"integerValue"in t)return tL(e.integerValue)===tL(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let r=tL(e.doubleValue),n=tL(t.doubleValue);return r===n?ex(r)===ex(n):isNaN(r)&&isNaN(n)}return!1;case 9:return z(e.arrayValue.values||[],t.arrayValue.values||[],t1);case 10:case 11:let s=e.mapValue.fields||{},a=t.mapValue.fields||{};if(tE(s)!==tE(a))return!1;for(let e in s)if(s.hasOwnProperty(e)&&(void 0===a[e]||!t1(s[e],a[e])))return!1;return!0;default:return S()}}function t2(e,t){return void 0!==(e.values||[]).find(e=>t1(e,t))}function t5(e,t){if(e===t)return 0;let r=t0(e),n=t0(t);if(r!==n)return U(r,n);switch(r){case 0:case 0x1fffffffffffff:return 0;case 1:return U(e.booleanValue,t.booleanValue);case 2:let i=tL(e.integerValue||e.doubleValue),s=tL(t.integerValue||t.doubleValue);return i<s?-1:i>s?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return t8(e.timestampValue,t.timestampValue);case 4:return t8(t$(e),t$(t));case 5:return q(e.stringValue,t.stringValue);case 6:return function(e,t){let r=tF(e),n=tF(t);return r.compareTo(n)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let r=e.split("/"),n=t.split("/");for(let e=0;e<r.length&&e<n.length;e++){let t=U(r[e],n[e]);if(0!==t)return t}return U(r.length,n.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let r=U(tL(e.latitude),tL(t.latitude));return 0!==r?r:U(tL(e.longitude),tL(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return t3(e.arrayValue,t.arrayValue);case 10:return function(e,t){var r,n,i,s;let a=e.fields||{},o=t.fields||{},l=null==(r=a[tJ])?void 0:r.arrayValue,u=null==(n=o[tJ])?void 0:n.arrayValue,h=U((null==(i=null==l?void 0:l.values)?void 0:i.length)||0,(null==(s=null==u?void 0:u.values)?void 0:s.length)||0);return 0!==h?h:t3(l,u)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===tY.mapValue&&t===tY.mapValue)return 0;if(e===tY.mapValue)return 1;if(t===tY.mapValue)return -1;let r=e.fields||{},n=Object.keys(r),i=t.fields||{},s=Object.keys(i);n.sort(),s.sort();for(let e=0;e<n.length&&e<s.length;++e){let t=q(n[e],s[e]);if(0!==t)return t;let a=t5(r[n[e]],i[s[e]]);if(0!==a)return a}return U(n.length,s.length)}(e.mapValue,t.mapValue);default:throw S()}}function t8(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return U(e,t);let r=tM(e),n=tM(t),i=U(r.seconds,n.seconds);return 0!==i?i:U(r.nanos,n.nanos)}function t3(e,t){let r=e.values||[],n=t.values||[];for(let e=0;e<r.length&&e<n.length;++e){let t=t5(r[e],n[e]);if(t)return t}return U(r.length,n.length)}function t4(e){var t,r;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tM(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?tF(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,Y.fromName(t).toString()):"geoPointValue"in e?(r=e.geoPointValue,`geo(${r.latitude},${r.longitude})`):"arrayValue"in e?function(e){let t="[",r=!0;for(let n of e.values||[])r?r=!1:t+=",",t+=t4(n);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),r="{",n=!0;for(let i of t)n?n=!1:r+=",",r+=`${i}:${t4(e.fields[i])}`;return r+"}"}(e.mapValue):S()}function t6(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function t9(e){return!!e&&"integerValue"in e}function t7(e){return!!e&&"arrayValue"in e}function re(e){return!!e&&"nullValue"in e}function rt(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function rr(e){return!!e&&"mapValue"in e}function rn(e){var t,r;return(null==(r=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{})[tH])?void 0:r.stringValue)===tZ}function ri(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){let t={mapValue:{fields:{}}};return tb(e.mapValue.fields,(e,r)=>t.mapValue.fields[e]=ri(r)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let r=0;r<(e.arrayValue.values||[]).length;++r)t.arrayValue.values[r]=ri(e.arrayValue.values[r]);return t}return Object.assign({},e)}function rs(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===tW}let ra={mapValue:{fields:{[tH]:{stringValue:tZ},[tJ]:{arrayValue:{}}}}};function ro(e,t){let r=t5(e.value,t.value);return 0!==r?r:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function rl(e,t){let r=t5(e.value,t.value);return 0!==r?r:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class ru{constructor(e){this.value=e}static empty(){return new ru({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(!rr(t=(t.mapValue.fields||{})[e.get(r)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=ri(t)}setAll(e){let t=W.emptyPath(),r={},n=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,r,n),r={},n=[],t=i.popLast()}e?r[i.lastSegment()]=ri(e):n.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,r,n)}delete(e){let t=this.field(e.popLast());rr(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return t1(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let n=t.mapValue.fields[e.get(r)];rr(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=n),t=n}return t.mapValue.fields}applyChanges(e,t,r){for(let n of(tb(t,(t,r)=>e[t]=r),r))delete e[n]}clone(){return new ru(ri(this.value))}}class rh{constructor(e,t,r,n,i,s,a){this.key=e,this.documentType=t,this.version=r,this.readTime=n,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new rh(e,0,$.min(),$.min(),$.min(),ru.empty(),0)}static newFoundDocument(e,t,r,n){return new rh(e,1,t,$.min(),r,n,0)}static newNoDocument(e,t){return new rh(e,2,t,$.min(),$.min(),ru.empty(),0)}static newUnknownDocument(e,t){return new rh(e,3,t,$.min(),$.min(),ru.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual($.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=ru.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=ru.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=$.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof rh&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new rh(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class rc{constructor(e,t){this.position=e,this.inclusive=t}}function rd(e,t,r){let n=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(n=s.field.isKeyField()?Y.comparator(Y.fromName(a.referenceValue),r.key):t5(a,r.data.field(s.field)),"desc"===s.dir&&(n*=-1),0!==n)break}return n}function rf(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let r=0;r<e.position.length;r++)if(!t1(e.position[r],t.position[r]))return!1;return!0}class rm{constructor(e,t="asc"){this.field=e,this.dir=t}}class rg{}class rp extends rg{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,r):new rb(e,t,r):"array-contains"===t?new rN(e,r):"in"===t?new rD(e,r):"not-in"===t?new rk(e,r):"array-contains-any"===t?new rC(e,r):new rp(e,t,r)}static createKeyFieldInFilter(e,t,r){return"in"===t?new r_(e,r):new rS(e,r)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(t5(t,this.value)):null!==t&&t0(this.value)===t0(t)&&this.matchesComparison(t5(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return S()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class ry extends rg{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new ry(e,t)}matches(e){return rw(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ce||(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}}function rw(e){return"and"===e.op}function rv(e){return"or"===e.op}function rI(e){return rT(e)&&rw(e)}function rT(e){for(let t of e.filters)if(t instanceof ry)return!1;return!0}function rE(e,t){let r=e.filters.concat(t);return ry.create(r,e.op)}class rb extends rp{constructor(e,t,r){super(e,t,r),this.key=Y.fromName(r.referenceValue)}matches(e){let t=Y.comparator(e.key,this.key);return this.matchesComparison(t)}}class r_ extends rp{constructor(e,t){super(e,"in",t),this.keys=rx("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class rS extends rp{constructor(e,t){super(e,"not-in",t),this.keys=rx("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function rx(e,t){var r;return((null==(r=t.arrayValue)?void 0:r.values)||[]).map(e=>Y.fromName(e.referenceValue))}class rN extends rp{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return t7(t)&&t2(t.arrayValue,this.value)}}class rD extends rp{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&t2(this.value.arrayValue,t)}}class rk extends rp{constructor(e,t){super(e,"not-in",t)}matches(e){if(t2(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&!t2(this.value.arrayValue,t)}}class rC extends rp{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!t7(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>t2(this.value.arrayValue,e))}}class rA{constructor(e,t=null,r=[],n=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=n,this.limit=i,this.startAt=s,this.endAt=a,this.le=null}}function rV(e,t=null,r=[],n=[],i=null,s=null,a=null){return new rA(e,t,r,n,i,s,a)}function rR(e){if(null===e.le){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof rp)return t.field.canonicalString()+t.op.toString()+t4(t.value);if(rI(t))return t.filters.map(t=>e(t)).join(",");{let r=t.filters.map(t=>e(t)).join(",");return`${t.op}(${r})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),eS(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>t4(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>t4(e)).join(",")),e.le=t}return e.le}function rO(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var r,n;if(r=e.orderBy[i],n=t.orderBy[i],!(r.dir===n.dir&&r.field.isEqual(n.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let r=0;r<e.filters.length;r++)if(!function e(t,r){return t instanceof rp?r instanceof rp&&t.op===r.op&&t.field.isEqual(r.field)&&t1(t.value,r.value):t instanceof ry?r instanceof ry&&t.op===r.op&&t.filters.length===r.filters.length&&t.filters.reduce((t,n,i)=>t&&e(n,r.filters[i]),!0):void S()}(e.filters[r],t.filters[r]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!rf(e.startAt,t.startAt)&&rf(e.endAt,t.endAt)}function rM(e){return Y.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function rL(e,t){return e.filters.filter(e=>e instanceof rp&&e.field.isEqual(t))}function rF(e,t,r){let n=tX,i=!0;for(let r of rL(e,t)){let e=tX,t=!0;switch(r.op){case"<":case"<=":var s;e="nullValue"in(s=r.value)?tX:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?t6(tQ.empty(),Y.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?rn(s)?ra:{mapValue:{}}:S();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=tX}0>ro({value:n,inclusive:i},{value:e,inclusive:t})&&(n=e,i=t)}if(null!==r){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=r.position[s];0>ro({value:n,inclusive:i},{value:e,inclusive:r.inclusive})&&(n=e,i=r.inclusive);break}}return{value:n,inclusive:i}}function rP(e,t,r){let n=tY,i=!0;for(let r of rL(e,t)){let e=tY,t=!0;switch(r.op){case">=":case">":var s;e="nullValue"in(s=r.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?t6(tQ.empty(),Y.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?ra:"mapValue"in s?rn(s)?{mapValue:{}}:tY:S(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=tY}rl({value:n,inclusive:i},{value:e,inclusive:t})>0&&(n=e,i=t)}if(null!==r){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=r.position[s];rl({value:n,inclusive:i},{value:e,inclusive:r.inclusive})>0&&(n=e,i=r.inclusive);break}}return{value:n,inclusive:i}}class rU{constructor(e,t=null,r=[],n=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=n,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.he=null,this.Pe=null,this.Te=null,this.startAt,this.endAt}}function rq(e){return new rU(e)}function rB(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function rz(e){return null!==e.collectionGroup}function rK(e){if(null===e.he){let t;e.he=[];let r=new Set;for(let t of e.explicitOrderBy)e.he.push(t),r.add(t.field.canonicalString());let n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tD(W.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{r.has(t.canonicalString())||t.isKeyField()||e.he.push(new rm(t,n))}),r.has(W.keyField().canonicalString())||e.he.push(new rm(W.keyField(),n))}return e.he}function r$(e){return e.Pe||(e.Pe=rG(e,rK(e))),e.Pe}function rG(e,t){if("F"===e.limitType)return rV(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new rm(e.field,t)});let r=e.endAt?new rc(e.endAt.position,e.endAt.inclusive):null,n=e.startAt?new rc(e.startAt.position,e.startAt.inclusive):null;return rV(e.path,e.collectionGroup,t,e.filters,e.limit,r,n)}}function rj(e,t){let r=e.filters.concat([t]);return new rU(e.path,e.collectionGroup,e.explicitOrderBy.slice(),r,e.limit,e.limitType,e.startAt,e.endAt)}function rQ(e,t,r){return new rU(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,r,e.startAt,e.endAt)}function rH(e,t){return rO(r$(e),r$(t))&&e.limitType===t.limitType}function rW(e){return`${rR(r$(e))}|lt:${e.limitType}`}function rY(e){var t;let r;return`Query(target=${r=(t=r$(e)).path.canonicalString(),null!==t.collectionGroup&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof rp?`${t.field.canonicalString()} ${t.op} ${t4(t.value)}`:t instanceof ry?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),eS(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(e=>t4(e)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(e=>t4(e)).join(",")),`Target(${r})`}; limitType=${e.limitType})`}function rZ(e,t){return t.isFoundDocument()&&function(e,t){let r=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(r):Y.isDocumentKey(e.path)?e.path.isEqual(r):e.path.isImmediateParentOf(r)}(e,t)&&function(e,t){for(let r of rK(e))if(!r.field.isKeyField()&&null===t.data.field(r.field))return!1;return!0}(e,t)&&function(e,t){for(let r of e.filters)if(!r.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,r){let n=rd(e,t,r);return e.inclusive?n<=0:n<0}(e.startAt,rK(e),t))&&(!e.endAt||!!function(e,t,r){let n=rd(e,t,r);return e.inclusive?n>=0:n>0}(e.endAt,rK(e),t))}function rJ(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function rX(e){return(t,r)=>{let n=!1;for(let i of rK(e)){let e=function(e,t,r){let n=e.field.isKeyField()?Y.comparator(t.key,r.key):function(e,t,r){let n=t.data.field(e),i=r.data.field(e);return null!==n&&null!==i?t5(n,i):S()}(e.field,t,r);switch(e.dir){case"asc":return n;case"desc":return -1*n;default:return S()}}(i,t,r);if(0!==e)return e;n=n||i.field.isKeyField()}return 0}}class r0{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(void 0!==r){for(let[t,n]of r)if(this.equalsFn(t,e))return n}}has(e){return void 0!==this.get(e)}set(e,t){let r=this.mapKeyFn(e),n=this.inner[r];if(void 0===n)return this.inner[r]=[[e,t]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return void(n[r]=[e,t]);n.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(void 0===r)return!1;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return 1===r.length?delete this.inner[t]:r.splice(n,1),this.innerSize--,!0;return!1}forEach(e){tb(this.inner,(t,r)=>{for(let[t,n]of r)e(t,n)})}isEmpty(){return t_(this.inner)}size(){return this.innerSize}}let r1=new tS(Y.comparator),r2=new tS(Y.comparator);function r5(...e){let t=r2;for(let r of e)t=t.insert(r.key,r);return t}function r8(e){let t=r2;return e.forEach((e,r)=>t=t.insert(e,r.overlayedDocument)),t}function r3(){return new r0(e=>e.toString(),(e,t)=>e.isEqual(t))}let r4=new tS(Y.comparator),r6=new tD(Y.comparator);function r9(...e){let t=r6;for(let r of e)t=t.add(r);return t}let r7=new tD(U);function ne(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ex(t)?"-0":t}}function nt(e){return{integerValue:""+e}}function nr(e,t){return eN(t)?nt(t):ne(e,t)}class nn{constructor(){this._=void 0}}function ni(e,t){return e instanceof nh?t9(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class ns extends nn{}class na extends nn{constructor(e){super(),this.elements=e}}function no(e,t){let r=nd(t);for(let t of e.elements)r.some(e=>t1(e,t))||r.push(t);return{arrayValue:{values:r}}}class nl extends nn{constructor(e){super(),this.elements=e}}function nu(e,t){let r=nd(t);for(let t of e.elements)r=r.filter(e=>!t1(e,t));return{arrayValue:{values:r}}}class nh extends nn{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function nc(e){return tL(e.integerValue||e.doubleValue)}function nd(e){return t7(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class nf{constructor(e,t){this.field=e,this.transform=t}}class nm{constructor(e,t){this.version=e,this.transformResults=t}}class ng{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new ng}static exists(e){return new ng(void 0,e)}static updateTime(e){return new ng(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function np(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class ny{}function nw(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new nx(e.key,ng.none()):new nT(e.key,e.data,ng.none());{let r=e.data,n=ru.empty(),i=new tD(W.comparator);for(let e of t.fields)if(!i.has(e)){let t=r.field(e);null===t&&e.length>1&&(e=e.popLast(),t=r.field(e)),null===t?n.delete(e):n.set(e,t),i=i.add(e)}return new nE(e.key,n,new tA(i.toArray()),ng.none())}}function nv(e,t,r,n){return e instanceof nT?function(e,t,r,n){if(!np(e.precondition,t))return r;let i=e.value.clone(),s=nS(e.fieldTransforms,n,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,r,n):e instanceof nE?function(e,t,r,n){if(!np(e.precondition,t))return r;let i=nS(e.fieldTransforms,n,t),s=t.data;return(s.setAll(nb(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===r)?null:r.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,r,n):np(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):r}function nI(e,t){var r,n;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(r=e.fieldTransforms,n=t.fieldTransforms,!!(void 0===r&&void 0===n||!(!r||!n)&&z(r,n,(e,t)=>{var r,n;return e.field.isEqual(t.field)&&(r=e.transform,n=t.transform,r instanceof na&&n instanceof na||r instanceof nl&&n instanceof nl?z(r.elements,n.elements,t1):r instanceof nh&&n instanceof nh?t1(r.Ie,n.Ie):r instanceof ns&&n instanceof ns)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class nT extends ny{constructor(e,t,r,n=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class nE extends ny{constructor(e,t,r,n,i=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=n,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function nb(e){let t=new Map;return e.fieldMask.fields.forEach(r=>{if(!r.isEmpty()){let n=e.data.field(r);t.set(r,n)}}),t}function n_(e,t,r){var n;let i=new Map;e.length===r.length||S();for(let s=0;s<r.length;s++){let a=e[s],o=a.transform,l=t.data.field(a.field);i.set(a.field,(n=r[s],o instanceof na?no(o,l):o instanceof nl?nu(o,l):n))}return i}function nS(e,t,r){let n=new Map;for(let i of e){let e=i.transform,s=r.data.field(i.field);n.set(i.field,e instanceof ns?function(e,t){let r={fields:{[tU]:{stringValue:tP},[tB]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tz(t)&&(t=tK(t)),t&&(r.fields[tq]=t),{mapValue:r}}(t,s):e instanceof na?no(e,s):e instanceof nl?nu(e,s):function(e,t){let r=ni(e,t),n=nc(r)+nc(e.Ie);return t9(r)&&t9(e.Ie)?nt(n):ne(e.serializer,n)}(e,s))}return n}class nx extends ny{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class nN extends ny{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class nD{constructor(e,t,r,n){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=n}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let n=this.mutations[t];n.key.isEqual(e.key)&&function(e,t,r){e instanceof nT?function(e,t,r){let n=e.value.clone(),i=n_(e.fieldTransforms,t,r.transformResults);n.setAll(i),t.convertToFoundDocument(r.version,n).setHasCommittedMutations()}(e,t,r):e instanceof nE?function(e,t,r){if(!np(e.precondition,t))return t.convertToUnknownDocument(r.version);let n=n_(e.fieldTransforms,t,r.transformResults),i=t.data;i.setAll(nb(e)),i.setAll(n),t.convertToFoundDocument(r.version,i).setHasCommittedMutations()}(e,t,r):t.convertToNoDocument(r.version).setHasCommittedMutations()}(n,e,r[t])}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=nv(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=nv(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=r3();return this.mutations.forEach(n=>{let i=e.get(n.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=nw(s,a=t.has(n.key)?null:a);null!==o&&r.set(n.key,o),s.isValidDocument()||s.convertToNoDocument($.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),r9())}isEqual(e){return this.batchId===e.batchId&&z(this.mutations,e.mutations,(e,t)=>nI(e,t))&&z(this.baseMutations,e.baseMutations,(e,t)=>nI(e,t))}}class nk{constructor(e,t,r,n){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=n}static from(e,t,r){e.mutations.length===r.length||S();let n=r4,i=e.mutations;for(let e=0;e<i.length;e++)n=n.insert(i[e].key,r[e].version);return new nk(e,t,r,n)}}class nC{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class nA{constructor(e,t){this.count=e,this.unchangedNames=t}}function nV(e){switch(e){case x.OK:return S();case x.CANCELLED:case x.UNKNOWN:case x.DEADLINE_EXCEEDED:case x.RESOURCE_EXHAUSTED:case x.INTERNAL:case x.UNAVAILABLE:case x.UNAUTHENTICATED:return!1;case x.INVALID_ARGUMENT:case x.NOT_FOUND:case x.ALREADY_EXISTS:case x.PERMISSION_DENIED:case x.FAILED_PRECONDITION:case x.ABORTED:case x.OUT_OF_RANGE:case x.UNIMPLEMENTED:case x.DATA_LOSS:return!0;default:return S()}}function nR(e){if(void 0===e)return E("GRPC error has no .code"),x.UNKNOWN;switch(e){case n.OK:return x.OK;case n.CANCELLED:return x.CANCELLED;case n.UNKNOWN:return x.UNKNOWN;case n.DEADLINE_EXCEEDED:return x.DEADLINE_EXCEEDED;case n.RESOURCE_EXHAUSTED:return x.RESOURCE_EXHAUSTED;case n.INTERNAL:return x.INTERNAL;case n.UNAVAILABLE:return x.UNAVAILABLE;case n.UNAUTHENTICATED:return x.UNAUTHENTICATED;case n.INVALID_ARGUMENT:return x.INVALID_ARGUMENT;case n.NOT_FOUND:return x.NOT_FOUND;case n.ALREADY_EXISTS:return x.ALREADY_EXISTS;case n.PERMISSION_DENIED:return x.PERMISSION_DENIED;case n.FAILED_PRECONDITION:return x.FAILED_PRECONDITION;case n.ABORTED:return x.ABORTED;case n.OUT_OF_RANGE:return x.OUT_OF_RANGE;case n.UNIMPLEMENTED:return x.UNIMPLEMENTED;case n.DATA_LOSS:return x.DATA_LOSS;default:return S()}}(i=n||(n={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let nO=new c.jz([0xffffffff,0xffffffff],0);function nM(e){let t=F().encode(e),r=new c.VV;return r.update(t),new Uint8Array(r.digest())}function nL(e){let t=new DataView(e.buffer),r=t.getUint32(0,!0),n=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new c.jz([r,n],0),new c.jz([i,s],0)]}class nF{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new nP(`Invalid padding: ${t}`);if(r<0||e.length>0&&0===this.hashCount)throw new nP(`Invalid hash count: ${r}`);if(0===e.length&&0!==t)throw new nP(`Invalid padding when bitmap length is 0: ${t}`);this.Ee=8*e.length-t,this.de=c.jz.fromNumber(this.Ee)}Ae(e,t,r){let n=e.add(t.multiply(c.jz.fromNumber(r)));return 1===n.compare(nO)&&(n=new c.jz([n.getBits(0),n.getBits(1)],0)),n.modulo(this.de).toNumber()}Re(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ee)return!1;let[t,r]=nL(nM(e));for(let e=0;e<this.hashCount;e++){let n=this.Ae(t,r,e);if(!this.Re(n))return!1}return!0}static create(e,t,r){let n=new nF(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return r.forEach(e=>n.insert(e)),n}insert(e){if(0===this.Ee)return;let[t,r]=nL(nM(e));for(let e=0;e<this.hashCount;e++){let n=this.Ae(t,r,e);this.Ve(n)}}Ve(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class nP extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class nU{constructor(e,t,r,n,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=n,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let n=new Map;return n.set(e,nq.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new nU($.min(),n,new tS(U),r1,r9())}}class nq{constructor(e,t,r,n,i){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=n,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new nq(r,t,r9(),r9(),r9())}}class nB{constructor(e,t,r,n){this.me=e,this.removedTargetIds=t,this.key=r,this.fe=n}}class nz{constructor(e,t){this.targetId=e,this.ge=t}}class nK{constructor(e,t,r=tR.EMPTY_BYTE_STRING,n=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=n}}class n${constructor(){this.pe=0,this.ye=nQ(),this.we=tR.EMPTY_BYTE_STRING,this.Se=!1,this.be=!0}get current(){return this.Se}get resumeToken(){return this.we}get De(){return 0!==this.pe}get ve(){return this.be}Ce(e){e.approximateByteSize()>0&&(this.be=!0,this.we=e)}Fe(){let e=r9(),t=r9(),r=r9();return this.ye.forEach((n,i)=>{switch(i){case 0:e=e.add(n);break;case 2:t=t.add(n);break;case 1:r=r.add(n);break;default:S()}}),new nq(this.we,this.Se,e,t,r)}Me(){this.be=!1,this.ye=nQ()}xe(e,t){this.be=!0,this.ye=this.ye.insert(e,t)}Oe(e){this.be=!0,this.ye=this.ye.remove(e)}Ne(){this.pe+=1}Be(){this.pe-=1,this.pe>=0||S()}Le(){this.be=!0,this.Se=!0}}class nG{constructor(e){this.ke=e,this.qe=new Map,this.Qe=r1,this.$e=nj(),this.Ue=nj(),this.Ke=new tS(U)}We(e){for(let t of e.me)e.fe&&e.fe.isFoundDocument()?this.Ge(t,e.fe):this.ze(t,e.key,e.fe);for(let t of e.removedTargetIds)this.ze(t,e.key,e.fe)}je(e){this.forEachTarget(e,t=>{let r=this.He(t);switch(e.state){case 0:this.Je(t)&&r.Ce(e.resumeToken);break;case 1:r.Be(),r.De||r.Me(),r.Ce(e.resumeToken);break;case 2:r.Be(),r.De||this.removeTarget(t);break;case 3:this.Je(t)&&(r.Le(),r.Ce(e.resumeToken));break;case 4:this.Je(t)&&(this.Ye(t),r.Ce(e.resumeToken));break;default:S()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.qe.forEach((e,r)=>{this.Je(r)&&t(r)})}Ze(e){let t=e.targetId,r=e.ge.count,n=this.Xe(t);if(n){let i=n.target;if(rM(i))if(0===r){let e=new Y(i.path);this.ze(t,e,rh.newNoDocument(e,$.min()))}else 1===r||S();else{let n=this.et(t);if(n!==r){let r=this.tt(e),i=r?this.nt(r,e,n):1;0!==i&&(this.Ye(t),this.Ke=this.Ke.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}tt(e){let t,r,n=e.ge.unchangedNames;if(!n||!n.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=n;try{t=tF(i).toUint8Array()}catch(e){if(e instanceof tV)return b("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{r=new nF(t,s,a)}catch(e){return b(e instanceof nP?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===r.Ee?null:r}nt(e,t,r){return 2*(t.ge.count!==r-this.st(e,t.targetId))}st(e,t){let r=this.ke.getRemoteKeysForTarget(t),n=0;return r.forEach(r=>{let i=this.ke.it(),s=`projects/${i.projectId}/databases/${i.database}/documents/${r.path.canonicalString()}`;e.mightContain(s)||(this.ze(t,r,null),n++)}),n}ot(e){let t=new Map;this.qe.forEach((r,n)=>{let i=this.Xe(n);if(i){if(r.current&&rM(i.target)){let t=new Y(i.target.path);this._t(t).has(n)||this.ut(n,t)||this.ze(n,t,rh.newNoDocument(t,e))}r.ve&&(t.set(n,r.Fe()),r.Me())}});let r=r9();this.Ue.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{let t=this.Xe(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(n=!1,!1)}),n&&(r=r.add(e))}),this.Qe.forEach((t,r)=>r.setReadTime(e));let n=new nU(e,t,this.Ke,this.Qe,r);return this.Qe=r1,this.$e=nj(),this.Ue=nj(),this.Ke=new tS(U),n}Ge(e,t){if(!this.Je(e))return;let r=2*!!this.ut(e,t.key);this.He(e).xe(t.key,r),this.Qe=this.Qe.insert(t.key,t),this.$e=this.$e.insert(t.key,this._t(t.key).add(e)),this.Ue=this.Ue.insert(t.key,this.ct(t.key).add(e))}ze(e,t,r){if(!this.Je(e))return;let n=this.He(e);this.ut(e,t)?n.xe(t,1):n.Oe(t),this.Ue=this.Ue.insert(t,this.ct(t).delete(e)),this.Ue=this.Ue.insert(t,this.ct(t).add(e)),r&&(this.Qe=this.Qe.insert(t,r))}removeTarget(e){this.qe.delete(e)}et(e){let t=this.He(e).Fe();return this.ke.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ne(e){this.He(e).Ne()}He(e){let t=this.qe.get(e);return t||(t=new n$,this.qe.set(e,t)),t}ct(e){let t=this.Ue.get(e);return t||(t=new tD(U),this.Ue=this.Ue.insert(e,t)),t}_t(e){let t=this.$e.get(e);return t||(t=new tD(U),this.$e=this.$e.insert(e,t)),t}Je(e){let t=null!==this.Xe(e);return t||T("WatchChangeAggregator","Detected inactive target",e),t}Xe(e){let t=this.qe.get(e);return t&&t.De?null:this.ke.lt(e)}Ye(e){this.qe.set(e,new n$),this.ke.getRemoteKeysForTarget(e).forEach(t=>{this.ze(e,t,null)})}ut(e,t){return this.ke.getRemoteKeysForTarget(e).has(t)}}function nj(){return new tS(Y.comparator)}function nQ(){return new tS(Y.comparator)}let nH={asc:"ASCENDING",desc:"DESCENDING"},nW={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},nY={and:"AND",or:"OR"};class nZ{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function nJ(e,t){return e.useProto3Json||eS(t)?t:{value:t}}function nX(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function n0(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function n1(e){return e||S(),$.fromTimestamp(function(e){let t=tM(e);return new K(t.seconds,t.nanos)}(e))}function n2(e,t){return n5(e,t).canonicalString()}function n5(e,t){let r=new Q(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?r:r.child(t)}function n8(e){let t=Q.fromString(e);return ic(t)||S(),t}function n3(e,t){return n2(e.databaseId,t.path)}function n4(e,t){let r=n8(t);if(r.get(1)!==e.databaseId.projectId)throw new N(x.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+r.get(1)+" vs "+e.databaseId.projectId);if(r.get(3)!==e.databaseId.database)throw new N(x.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+r.get(3)+" vs "+e.databaseId.database);return new Y(ie(r))}function n6(e,t){return n2(e.databaseId,t)}function n9(e){let t=n8(e);return 4===t.length?Q.emptyPath():ie(t)}function n7(e){return new Q(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function ie(e){return e.length>4&&"documents"===e.get(4)||S(),e.popFirst(5)}function it(e,t,r){return{name:n3(e,t),fields:r.value.mapValue.fields}}function ir(e,t,r){let n=n4(e,t.name),i=n1(t.updateTime),s=t.createTime?n1(t.createTime):$.min(),a=new ru({mapValue:{fields:t.fields}}),o=rh.newFoundDocument(n,i,s,a);return r&&o.setHasCommittedMutations(),r?o.setHasCommittedMutations():o}function ii(e,t){var r;let n;if(t instanceof nT)n={update:it(e,t.key,t.value)};else if(t instanceof nx)n={delete:n3(e,t.key)};else if(t instanceof nE)n={update:it(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof nN))return S();n={verify:n3(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let r=t.transform;if(r instanceof ns)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(r instanceof na)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:r.elements}};if(r instanceof nl)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:r.elements}};if(r instanceof nh)return{fieldPath:t.field.canonicalString(),increment:r.Ie};throw S()})(0,e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:nX(e,r.updateTime.toTimestamp())}:void 0!==r.exists?{exists:r.exists}:S()),n}function is(e,t){var r;let n=t.currentDocument?void 0!==(r=t.currentDocument).updateTime?ng.updateTime(n1(r.updateTime)):void 0!==r.exists?ng.exists(r.exists):ng.none():ng.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{var r,n;let i;return r=e,i=null,"setToServerValue"in(n=t)?("REQUEST_TIME"===n.setToServerValue||S(),i=new ns):"appendMissingElements"in n?i=new na(n.appendMissingElements.values||[]):"removeAllFromArray"in n?i=new nl(n.removeAllFromArray.values||[]):"increment"in n?i=new nh(r,n.increment):S(),new nf(W.fromServerFormat(n.fieldPath),i)}):[];if(t.update){t.update.name;let r=n4(e,t.update.name),s=new ru({mapValue:{fields:t.update.fields}});return t.updateMask?new nE(r,s,new tA((t.updateMask.fieldPaths||[]).map(e=>W.fromServerFormat(e))),n,i):new nT(r,s,n,i)}return t.delete?new nx(n4(e,t.delete),n):t.verify?new nN(n4(e,t.verify),n):S()}function ia(e,t){return{documents:[n6(e,t.path)]}}function io(e,t){var r,n;let i,s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=n6(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof rp?function(e){if("=="===e.op){if(rt(e.value))return{unaryFilter:{field:iu(e.field),op:"IS_NAN"}};if(re(e.value))return{unaryFilter:{field:iu(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(rt(e.value))return{unaryFilter:{field:iu(e.field),op:"IS_NOT_NAN"}};if(re(e.value))return{unaryFilter:{field:iu(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iu(e.field),op:nW[e.op],value:e.value}}}(t):t instanceof ry?function(t){let r=t.getFilters().map(t=>e(t));return 1===r.length?r[0]:{compositeFilter:{op:nY[t.op],filters:r}}}(t):S()}(ry.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:iu(e.field),direction:nH[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=nJ(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(r=t.startAt).inclusive,values:r.position}),t.endAt&&(s.structuredQuery.endAt={before:!(n=t.endAt).inclusive,values:n.position}),{ht:s,parent:i}}function il(e){var t;let r,n=n9(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){1===s||S();let e=i.from[0];e.allDescendants?a=e.collectionId:n=n.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=ih(e.unaryFilter.field);return rp.create(t,"==",{doubleValue:NaN});case"IS_NULL":let r=ih(e.unaryFilter.field);return rp.create(r,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let n=ih(e.unaryFilter.field);return rp.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=ih(e.unaryFilter.field);return rp.create(i,"!=",{nullValue:"NULL_VALUE"});default:return S()}}(t):void 0!==t.fieldFilter?rp.create(ih(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return S()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?ry.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return S()}}(t.compositeFilter.op)):S()}(e);return t instanceof ry&&rI(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new rm(ih(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=eS(r="object"==typeof(t=i.limit)?t.value:t)?null:r);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new rc(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new rc(e.values||[],t)}(i.endAt)),new rU(n,a,l,o,u,"F",h,c)}function iu(e){return{fieldPath:e.canonicalString()}}function ih(e){return W.fromServerFormat(e.fieldPath)}function ic(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class id{constructor(e,t,r,n,i=$.min(),s=$.min(),a=tR.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=n,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new id(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new id(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new id(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new id(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class im{constructor(e){this.Tt=e}}function ig(e,t){let r=t.key,n={prefixPath:r.getCollectionPath().popLast().toArray(),collectionGroup:r.collectionGroup,documentId:r.path.lastSegment(),readTime:ip(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;n.document={name:n3(i=e.Tt,t.key),fields:t.data.value.mapValue.fields,updateTime:nX(i,t.version.toTimestamp()),createTime:nX(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())n.noDocument={path:r.path.toArray(),readTime:iy(t.version)};else{if(!t.isUnknownDocument())return S();n.unknownDocument={path:r.path.toArray(),version:iy(t.version)}}return n}function ip(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iy(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function iw(e){let t=new K(e.seconds,e.nanoseconds);return $.fromTimestamp(t)}function iv(e,t){let r=(t.baseMutations||[]).map(t=>is(e.Tt,t));for(let e=0;e<t.mutations.length-1;++e){let r=t.mutations[e];e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform&&(r.updateTransforms=t.mutations[e+1].transform.fieldTransforms,t.mutations.splice(e+1,1),++e)}let n=t.mutations.map(t=>is(e.Tt,t)),i=K.fromMillis(t.localWriteTimeMs);return new nD(t.batchId,i,r,n)}function iI(e){var t;let r=iw(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?iw(e.lastLimboFreeSnapshotVersion):$.min();return new id(void 0!==e.query.documents?(1===(t=e.query).documents.length||S(),r$(rq(n9(t.documents[0])))):r$(il(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,r,n,tR.fromBase64String(e.resumeToken))}function iT(e,t){let r,n=iy(t.snapshotVersion),i=iy(t.lastLimboFreeSnapshotVersion);r=rM(t.target)?ia(e.Tt,t.target):io(e.Tt,t.target).ht;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:rR(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:r}}function iE(e){let t=il({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?rQ(t,t.limit,"L"):t}function ib(e,t){return new nC(t.largestBatchId,is(e.Tt,t.overlayMutation))}function i_(e,t){let r=t.path.lastSegment();return[e,eD(t.path.popLast()),r]}function iS(e,t,r,n){return{indexId:e,uid:t,sequenceNumber:r,readTime:iy(n.readTime),documentKey:eD(n.documentKey.path),largestBatchId:n.largestBatchId}}class ix{getBundleMetadata(e,t){return tT(e,e4).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:iw(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tT(e,e4).put({bundleId:t.id,createTime:iy(n1(t.createTime)),version:t.version})}getNamedQuery(e,t){return tT(e,e6).get(t).next(e=>{if(e)return{name:e.name,query:iE(e.bundledQuery),readTime:iw(e.readTime)}})}saveNamedQuery(e,t){return tT(e,e6).put({name:t.name,readTime:iy(n1(t.readTime)),bundledQuery:t.bundledQuery})}}class iN{constructor(e,t){this.serializer=e,this.userId=t}static It(e,t){return new iN(e,t.uid||"")}getOverlay(e,t){return tT(e,tl).get(i_(this.userId,t)).next(e=>e?ib(this.serializer,e):null)}getOverlays(e,t){let r=r3();return eu.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&r.set(t,e)})).next(()=>r)}saveOverlays(e,t,r){let n=[];return r.forEach((r,i)=>{let s=new nC(t,i);n.push(this.Et(e,s))}),eu.waitFor(n)}removeOverlaysForBatchId(e,t,r){let n=new Set;t.forEach(e=>n.add(eD(e.getCollectionPath())));let i=[];return n.forEach(t=>{let n=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,r+1],!1,!0);i.push(tT(e,tl).J(th,n))}),eu.waitFor(i)}getOverlaysForCollection(e,t,r){let n=r3(),i=eD(t),s=IDBKeyRange.bound([this.userId,i,r],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tT(e,tl).G(th,s).next(e=>{for(let t of e){let e=ib(this.serializer,t);n.set(e.getKey(),e)}return n})}getOverlaysForCollectionGroup(e,t,r,n){let i,s=r3(),a=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tT(e,tl).Z({index:td,range:a},(e,t,r)=>{let a=ib(this.serializer,t);s.size()<n||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):r.done()}).next(()=>s)}Et(e,t){return tT(e,tl).put(function(e,t,r){let[n,i,s]=i_(t,r.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:r.mutation.key.getCollectionGroup(),largestBatchId:r.largestBatchId,overlayMutation:ii(e.Tt,r.mutation)}}(this.serializer,this.userId,t))}}class iD{dt(e){return tT(e,tm)}getSessionToken(e){return this.dt(e).get("sessionToken").next(e=>{let t=null==e?void 0:e.value;return t?tR.fromUint8Array(t):tR.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.dt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class ik{constructor(){}At(e,t){this.Rt(e,t),t.Vt()}Rt(e,t){if("nullValue"in e)this.ft(t,5);else if("booleanValue"in e)this.ft(t,10),t.gt(+!!e.booleanValue);else if("integerValue"in e)this.ft(t,15),t.gt(tL(e.integerValue));else if("doubleValue"in e){let r=tL(e.doubleValue);isNaN(r)?this.ft(t,13):(this.ft(t,15),ex(r)?t.gt(0):t.gt(r))}else if("timestampValue"in e){let r=e.timestampValue;this.ft(t,20),"string"==typeof r&&(r=tM(r)),t.yt(`${r.seconds||""}`),t.gt(r.nanos||0)}else if("stringValue"in e)this.wt(e.stringValue,t),this.St(t);else if("bytesValue"in e)this.ft(t,30),t.bt(tF(e.bytesValue)),this.St(t);else if("referenceValue"in e)this.Dt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.ft(t,45),t.gt(r.latitude||0),t.gt(r.longitude||0)}else"mapValue"in e?rs(e)?this.ft(t,Number.MAX_SAFE_INTEGER):rn(e)?this.vt(e.mapValue,t):(this.Ct(e.mapValue,t),this.St(t)):"arrayValue"in e?(this.Ft(e.arrayValue,t),this.St(t)):S()}wt(e,t){this.ft(t,25),this.Mt(e,t)}Mt(e,t){t.yt(e)}Ct(e,t){let r=e.fields||{};for(let e of(this.ft(t,55),Object.keys(r)))this.wt(e,t),this.Rt(r[e],t)}vt(e,t){var r,n;let i=e.fields||{};this.ft(t,53);let s=(null==(n=null==(r=i[tJ].arrayValue)?void 0:r.values)?void 0:n.length)||0;this.ft(t,15),t.gt(tL(s)),this.wt(tJ,t),this.Rt(i[tJ],t)}Ft(e,t){let r=e.values||[];for(let e of(this.ft(t,50),r))this.Rt(e,t)}Dt(e,t){this.ft(t,37),Y.fromName(e).path.forEach(e=>{this.ft(t,60),this.Mt(e,t)})}ft(e,t){e.gt(t)}St(e){e.gt(2)}}function iC(e){return Math.ceil((64-function(e){let t=0;for(let r=0;r<8;++r){let n=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e))/8)}ik.xt=new ik;class iA{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ot(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Nt(r.value),r=t.next();this.Bt()}Lt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.kt(r.value),r=t.next();this.qt()}Qt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Nt(e);else if(e<2048)this.Nt(960|e>>>6),this.Nt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Nt(480|e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e);else{let e=t.codePointAt(0);this.Nt(240|e>>>18),this.Nt(128|63&e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e)}}this.Bt()}$t(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.kt(e);else if(e<2048)this.kt(960|e>>>6),this.kt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.kt(480|e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e);else{let e=t.codePointAt(0);this.kt(240|e>>>18),this.kt(128|63&e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e)}}this.qt()}Ut(e){let t=this.Kt(e),r=iC(t);this.Wt(1+r),this.buffer[this.position++]=255&r;for(let e=t.length-r;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Gt(e){let t=this.Kt(e),r=iC(t);this.Wt(1+r),this.buffer[this.position++]=~(255&r);for(let e=t.length-r;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}zt(){this.jt(255),this.jt(255)}Ht(){this.Jt(255),this.Jt(255)}reset(){this.position=0}seed(e){this.Wt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Yt(){return this.buffer.slice(0,this.position)}Kt(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),r=!!(128&t[0]);t[0]^=r?255:128;for(let e=1;e<t.length;++e)t[e]^=255*!!r;return t}Nt(e){let t=255&e;0===t?(this.jt(0),this.jt(255)):255===t?(this.jt(255),this.jt(0)):this.jt(t)}kt(e){let t=255&e;0===t?(this.Jt(0),this.Jt(255)):255===t?(this.Jt(255),this.Jt(0)):this.Jt(e)}Bt(){this.jt(0),this.jt(1)}qt(){this.Jt(0),this.Jt(1)}jt(e){this.Wt(1),this.buffer[this.position++]=e}Jt(e){this.Wt(1),this.buffer[this.position++]=~e}Wt(e){let t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);let n=new Uint8Array(r);n.set(this.buffer),this.buffer=n}}class iV{constructor(e){this.Zt=e}bt(e){this.Zt.Ot(e)}yt(e){this.Zt.Qt(e)}gt(e){this.Zt.Ut(e)}Vt(){this.Zt.zt()}}class iR{constructor(e){this.Zt=e}bt(e){this.Zt.Lt(e)}yt(e){this.Zt.$t(e)}gt(e){this.Zt.Gt(e)}Vt(){this.Zt.Ht()}}class iO{constructor(){this.Zt=new iA,this.Xt=new iV(this.Zt),this.en=new iR(this.Zt)}seed(e){this.Zt.seed(e)}tn(e){return 0===e?this.Xt:this.en}Yt(){return this.Zt.Yt()}reset(){this.Zt.reset()}}class iM{constructor(e,t,r,n){this.indexId=e,this.documentKey=t,this.arrayValue=r,this.directionalValue=n}nn(){let e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,r=new Uint8Array(t);return r.set(this.directionalValue,0),t!==e?r.set([0],this.directionalValue.length):++r[r.length-1],new iM(this.indexId,this.documentKey,this.arrayValue,r)}}function iL(e,t){let r=e.indexId-t.indexId;return 0!==r||0!==(r=iF(e.arrayValue,t.arrayValue))||0!==(r=iF(e.directionalValue,t.directionalValue))?r:Y.comparator(e.documentKey,t.documentKey)}function iF(e,t){for(let r=0;r<e.length&&r<t.length;++r){let n=e[r]-t[r];if(0!==n)return n}return e.length-t.length}class iP{constructor(e){for(let t of(this.rn=new tD((e,t)=>W.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.sn=e.orderBy,this._n=[],e.filters))t.isInequality()?this.rn=this.rn.add(t):this._n.push(t)}get an(){return this.rn.size>1}un(e){if(e.collectionGroup===this.collectionId||S(),this.an)return!1;let t=J(e);if(void 0!==t&&!this.cn(t))return!1;let r=X(e),n=new Set,i=0,s=0;for(;i<r.length&&this.cn(r[i]);++i)n=n.add(r[i].fieldPath.canonicalString());if(i===r.length)return!0;if(this.rn.size>0){let e=this.rn.getIterator().getNext();if(!n.has(e.field.canonicalString())){let t=r[i];if(!this.ln(e,t)||!this.hn(this.sn[s++],t))return!1}++i}for(;i<r.length;++i){let e=r[i];if(s>=this.sn.length||!this.hn(this.sn[s++],e))return!1}return!0}Pn(){if(this.an)return null;let e=new tD(W.comparator),t=[];for(let r of this._n)if(!r.field.isKeyField())if("array-contains"===r.op||"array-contains-any"===r.op)t.push(new ee(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new ee(r.field,0))}for(let r of this.sn)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new ee(r.field,+("asc"!==r.dir))));return new Z(Z.UNKNOWN_ID,this.collectionId,t,et.empty())}cn(e){for(let t of this._n)if(this.ln(t,e))return!0;return!1}ln(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let r="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===r}hn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iU(e){return e instanceof rp}function iq(e){return e instanceof ry&&rI(e)}function iB(e){return iU(e)||iq(e)||function(e){if(e instanceof ry&&rv(e)){for(let t of e.getFilters())if(!iU(t)&&!iq(t))return!1;return!0}return!1}(e)}function iz(e,t){return e instanceof rp||e instanceof ry||S(),t instanceof rp||t instanceof ry||S(),i$(e instanceof rp?t instanceof rp?ry.create([e,t],"and"):iK(e,t):t instanceof rp?iK(t,e):function(e,t){if(e.filters.length>0&&t.filters.length>0||S(),rw(e)&&rw(t))return rE(e,t.getFilters());let r=rv(e)?e:t,n=rv(e)?t:e,i=r.filters.map(e=>iz(e,n));return ry.create(i,"or")}(e,t))}function iK(e,t){if(rw(t))return rE(t,e.getFilters());{let r=t.filters.map(t=>iz(e,t));return ry.create(r,"or")}}function i$(e){if(e instanceof rp||e instanceof ry||S(),e instanceof rp)return e;let t=e.getFilters();if(1===t.length)return i$(t[0]);if(rT(e))return e;let r=t.map(e=>i$(e)),n=[];return r.forEach(t=>{t instanceof rp?n.push(t):t instanceof ry&&(t.op===e.op?n.push(...t.filters):n.push(t))}),1===n.length?n[0]:ry.create(n,e.op)}class iG{constructor(){this.Tn=new ij}addToCollectionParentIndex(e,t){return this.Tn.add(t),eu.resolve()}getCollectionParents(e,t){return eu.resolve(this.Tn.getEntries(t))}addFieldIndex(e,t){return eu.resolve()}deleteFieldIndex(e,t){return eu.resolve()}deleteAllFieldIndexes(e){return eu.resolve()}createTargetIndexes(e,t){return eu.resolve()}getDocumentsMatchingTarget(e,t){return eu.resolve(null)}getIndexType(e,t){return eu.resolve(0)}getFieldIndexes(e,t){return eu.resolve([])}getNextCollectionGroupToUpdate(e){return eu.resolve(null)}getMinOffset(e,t){return eu.resolve(ei.min())}getMinOffsetFromCollectionGroup(e,t){return eu.resolve(ei.min())}updateCollectionGroup(e,t,r){return eu.resolve()}updateIndexEntries(e,t){return eu.resolve()}}class ij{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),n=this.index[t]||new tD(Q.comparator),i=!n.has(r);return this.index[t]=n.add(r),i}has(e){let t=e.lastSegment(),r=e.popLast(),n=this.index[t];return n&&n.has(r)}getEntries(e){return(this.index[e]||new tD(Q.comparator)).toArray()}}let iQ="IndexedDbIndexManager",iH=new Uint8Array(0);class iW{constructor(e,t){this.databaseId=t,this.In=new ij,this.En=new r0(e=>rR(e),(e,t)=>rO(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.In.has(t)){let r=t.lastSegment(),n=t.popLast();e.addOnCommittedListener(()=>{this.In.add(t)});let i={collectionId:r,parent:eD(n)};return tT(e,e5).put(i)}return eu.resolve()}getCollectionParents(e,t){let r=[],n=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tT(e,e5).G(n).next(e=>{for(let n of e){if(n.collectionId!==t)break;r.push(ek(n.parent))}return r})}addFieldIndex(e,t){let r=tT(e,e9),n={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete n.indexId;let i=r.add(n);if(t.indexState){let r=tT(e,te);return i.next(e=>{r.put(iS(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let r=tT(e,e9),n=tT(e,te),i=tT(e,ti);return r.delete(t.indexId).next(()=>n.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tT(e,e9),r=tT(e,ti),n=tT(e,te);return t.J().next(()=>r.J()).next(()=>n.J())}createTargetIndexes(e,t){return eu.forEach(this.dn(t),t=>this.getIndexType(e,t).next(r=>{if(0===r||1===r){let r=new iP(t).Pn();if(null!=r)return this.addFieldIndex(e,r)}}))}getDocumentsMatchingTarget(e,t){let r=tT(e,ti),n=!0,i=new Map;return eu.forEach(this.dn(t),t=>this.An(e,t).next(e=>{n&&(n=!!e),i.set(t,e)})).next(()=>{if(n){let e=r9(),n=[];return eu.forEach(i,(i,s)=>{T(iQ,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${rR(t)}`);let a=function(e,t){let r=J(t);if(void 0===r)return null;for(let t of rL(e,r.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let r=new Map;for(let n of X(t))for(let t of rL(e,n.fieldPath))switch(t.op){case"==":case"in":r.set(n.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return r.set(n.fieldPath.canonicalString(),t.value),Array.from(r.values())}return null}(s,i),l=function(e,t){let r=[],n=!0;for(let i of X(t)){let t=0===i.kind?rF(e,i.fieldPath,e.startAt):rP(e,i.fieldPath,e.startAt);r.push(t.value),n&&(n=t.inclusive)}return new rc(r,n)}(s,i),u=function(e,t){let r=[],n=!0;for(let i of X(t)){let t=0===i.kind?rP(e,i.fieldPath,e.endAt):rF(e,i.fieldPath,e.endAt);r.push(t.value),n&&(n=t.inclusive)}return new rc(r,n)}(s,i),h=this.Rn(i,s,l),c=this.Rn(i,s,u),d=this.Vn(i,s,o),f=this.mn(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return eu.forEach(f,i=>r.H(i,t.limit).next(t=>{t.forEach(t=>{let r=Y.fromSegments(t.documentKey);e.has(r)||(e=e.add(r),n.push(r))})}))}).next(()=>n)}return eu.resolve(null)})}dn(e){let t=this.En.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(t instanceof rp||t instanceof ry||S(),t instanceof rp)return t;if(1===t.filters.length)return e(t.filters[0]);let r=t.filters.map(t=>e(t)),n=ry.create(r,t.op);return iB(n=i$(n))?n:(n instanceof ry||S(),rw(n)||S(),n.filters.length>1||S(),n.filters.reduce((e,t)=>iz(e,t)))}(function e(t){var r,n;if(t instanceof rp||t instanceof ry||S(),t instanceof rp){if(t instanceof rD){let e=(null==(n=null==(r=t.value.arrayValue)?void 0:r.values)?void 0:n.map(e=>rp.create(t.field,"==",e)))||[];return ry.create(e,"or")}return t}let i=t.filters.map(t=>e(t));return ry.create(i,t.op)}(e));return iB(t)||S(),iU(t)||iq(t)?[t]:t.getFilters()})(ry.create(e.filters,"and")).map(t=>rV(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.En.set(e,t)),t}mn(e,t,r,n,i,s,a){let o=(null!=t?t.length:1)*Math.max(r.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.fn(t[h/l]):iH,c=this.gn(e,o,r[h%l],n),d=this.pn(e,o,i[h%l],s),f=a.map(t=>this.gn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}gn(e,t,r,n){let i=new iM(e,Y.empty(),t,r);return n?i:i.nn()}pn(e,t,r,n){let i=new iM(e,Y.empty(),t,r);return n?i.nn():i}An(e,t){let r=new iP(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(let n of e)r.un(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let r=2,n=this.dn(t);return eu.forEach(n,t=>this.An(e,t).next(e=>{e?0!==r&&e.fields.length<function(e){let t=new tD(W.comparator),r=!1;for(let n of e.filters)for(let e of n.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?r=!0:t=t.add(e.field));for(let r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+ +!!r}(t)&&(r=1):r=0})).next(()=>null!==t.limit&&n.length>1&&2===r?1:r)}yn(e,t){let r=new iO;for(let n of X(e)){let e=t.data.field(n.fieldPath);if(null==e)return null;let i=r.tn(n.kind);ik.xt.At(e,i)}return r.Yt()}fn(e){let t=new iO;return ik.xt.At(e,t.tn(0)),t.Yt()}wn(e,t){let r=new iO;return ik.xt.At(t6(this.databaseId,t),r.tn(function(e){let t=X(e);return 0===t.length?0:t[t.length-1].kind}(e))),r.Yt()}Vn(e,t,r){if(null===r)return[];let n=[];n.push(new iO);let i=0;for(let s of X(e)){let e=r[i++];for(let r of n)if(this.Sn(t,s.fieldPath)&&t7(e))n=this.bn(n,s,e);else{let t=r.tn(s.kind);ik.xt.At(e,t)}}return this.Dn(n)}Rn(e,t,r){return this.Vn(e,t,r.position)}Dn(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e[r].Yt();return t}bn(e,t,r){let n=[...e],i=[];for(let e of r.arrayValue.values||[])for(let r of n){let n=new iO;n.seed(r.Yt()),ik.xt.At(e,n.tn(t.kind)),i.push(n)}return i}Sn(e,t){return!!e.filters.find(e=>e instanceof rp&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let r=tT(e,e9),n=tT(e,te);return(t?r.G(e7,IDBKeyRange.bound(t,t)):r.G()).next(e=>{let t=[];return eu.forEach(e,e=>n.get([e.indexId,this.uid]).next(r=>{t.push(function(e,t){let r=t?new et(t.sequenceNumber,new ei(iw(t.readTime),new Y(ek(t.documentKey)),t.largestBatchId)):et.empty(),n=e.fields.map(([e,t])=>new ee(W.fromServerFormat(e),t));return new Z(e.indexId,e.collectionGroup,n,r)}(e,r))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let r=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==r?r:U(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,r){let n=tT(e,e9),i=tT(e,te);return this.vn(e).next(e=>n.G(e7,IDBKeyRange.bound(t,t)).next(t=>eu.forEach(t,t=>i.put(iS(t.indexId,this.uid,e,r)))))}updateIndexEntries(e,t){let r=new Map;return eu.forEach(t,(t,n)=>{let i=r.get(t.collectionGroup);return(i?eu.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(r.set(t.collectionGroup,i),eu.forEach(i,r=>this.Cn(e,t,r).next(t=>{let i=this.Fn(n,r);return t.isEqual(i)?eu.resolve():this.Mn(e,n,r,t,i)}))))})}xn(e,t,r,n){return tT(e,ti).put({indexId:n.indexId,uid:this.uid,arrayValue:n.arrayValue,directionalValue:n.directionalValue,orderedDocumentKey:this.wn(r,t.key),documentKey:t.key.path.toArray()})}On(e,t,r,n){return tT(e,ti).delete([n.indexId,this.uid,n.arrayValue,n.directionalValue,this.wn(r,t.key),t.key.path.toArray()])}Cn(e,t,r){let n=tT(e,ti),i=new tD(iL);return n.Z({index:ta,range:IDBKeyRange.only([r.indexId,this.uid,this.wn(r,t)])},(e,n)=>{i=i.add(new iM(r.indexId,t,n.arrayValue,n.directionalValue))}).next(()=>i)}Fn(e,t){let r=new tD(iL),n=this.yn(t,e);if(null==n)return r;let i=J(t);if(null!=i){let s=e.data.field(i.fieldPath);if(t7(s))for(let i of s.arrayValue.values||[])r=r.add(new iM(t.indexId,e.key,this.fn(i),n))}else r=r.add(new iM(t.indexId,e.key,iH,n));return r}Mn(e,t,r,n,i){T(iQ,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,r,n,i){let s=e.getIterator(),a=t.getIterator(),o=tC(s),l=tC(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let n=r(o,l);n<0?t=!0:n>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(n(l),l=tC(a)):t?(i(o),o=tC(s)):(o=tC(s),l=tC(a))}}(n,i,iL,n=>{s.push(this.xn(e,t,r,n))},n=>{s.push(this.On(e,t,r,n))}),eu.waitFor(s)}vn(e){let t=1;return tT(e,te).Z({index:tr,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,r,n)=>{n.done(),t=r.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((e,t)=>iL(e,t)).filter((e,t,r)=>!t||0!==iL(e,r[t-1]));let n=[];for(let i of(n.push(e),r)){let r=iL(i,e),s=iL(i,t);if(0===r)n[0]=e.nn();else if(r>0&&s<0)n.push(i),n.push(i.nn());else if(s>0)break}n.push(t);let i=[];for(let e=0;e<n.length;e+=2){if(this.Nn(n[e],n[e+1]))return[];let t=[n[e].indexId,this.uid,n[e].arrayValue,n[e].directionalValue,iH,[]],r=[n[e+1].indexId,this.uid,n[e+1].arrayValue,n[e+1].directionalValue,iH,[]];i.push(IDBKeyRange.bound(t,r))}return i}Nn(e,t){return iL(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(iY)}getMinOffset(e,t){return eu.mapArray(this.dn(t),t=>this.An(e,t).next(e=>e||S())).next(iY)}}function iY(e){0!==e.length||S();let t=e[0].indexState.offset,r=t.largestBatchId;for(let n=1;n<e.length;n++){let i=e[n].indexState.offset;0>es(i,t)&&(t=i),r<i.largestBatchId&&(r=i.largestBatchId)}return new ei(t.readTime,t.documentKey,r)}let iZ={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class iJ{static withCacheSize(e){return new iJ(e,iJ.DEFAULT_COLLECTION_PERCENTILE,iJ.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}}function iX(e,t,r){let n=e.store(eO),i=e.store(eU),s=[],a=IDBKeyRange.only(r.batchId),o=0,l=n.Z({range:a},(e,t,r)=>(o++,r.delete()));s.push(l.next(()=>{1===o||S()}));let u=[];for(let e of r.mutations){var h,c;let n=(h=e.key.path,c=r.batchId,[t,eD(h),c]);s.push(i.delete(n)),u.push(e.key)}return eu.waitFor(s).next(()=>u)}function i0(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw S();t=e.noDocument}return JSON.stringify(t).length}iJ.DEFAULT_COLLECTION_PERCENTILE=10,iJ.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,iJ.DEFAULT=new iJ(0x2800000,iJ.DEFAULT_COLLECTION_PERCENTILE,iJ.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),iJ.DISABLED=new iJ(-1,0,0);class i1{constructor(e,t,r,n){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=n,this.Bn={}}static It(e,t,r,n){return""!==e.uid||S(),new i1(e.isAuthenticated()?e.uid:"",t,r,n)}checkEmpty(e){let t=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return i5(e).Z({index:eL,range:r},(e,r,n)=>{t=!1,n.done()}).next(()=>t)}addMutationBatch(e,t,r,n){let i=tT(e,eU),s=i5(e);return s.add({}).next(a=>{var o,l;"number"==typeof a||S();let u=new nD(a,t,r,n),h=function(e,t,r){let n=r.baseMutations.map(t=>ii(e.Tt,t)),i=r.mutations.map(t=>ii(e.Tt,t));return{userId:t,batchId:r.batchId,localWriteTimeMs:r.localWriteTime.toMillis(),baseMutations:n,mutations:i}}(this.serializer,this.userId,u),c=[],d=new tD((e,t)=>U(e.canonicalString(),t.canonicalString()));for(let e of n){let t=(o=this.userId,l=e.key.path,[o,eD(l),a]);d=d.add(e.key.path.popLast()),c.push(s.put(h)),c.push(i.put(t,eP))}return d.forEach(t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Bn[a]=u.keys()}),eu.waitFor(c).next(()=>u)})}lookupMutationBatch(e,t){return i5(e).get(t).next(e=>e?(e.userId===this.userId||S(),iv(this.serializer,e)):null)}Ln(e,t){return this.Bn[t]?eu.resolve(this.Bn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let r=e.keys();return this.Bn[t]=r,r}return null})}getNextMutationBatchAfterBatchId(e,t){let r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]),i=null;return i5(e).Z({index:eL,range:n},(e,t,n)=>{t.userId===this.userId&&(t.batchId>=r||S(),i=iv(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return i5(e).Z({index:eL,range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return i5(e).G(eL,t).next(e=>e.map(e=>iv(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let r=[this.userId,eD(t.path)],n=IDBKeyRange.lowerBound(r),i=[];return tT(e,eU).Z({range:n},(r,n,s)=>{let[a,o,l]=r,u=ek(o);if(a===this.userId&&t.path.isEqual(u))return i5(e).get(l).next(e=>{if(!e)throw S();e.userId===this.userId||S(),i.push(iv(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new tD(U),n=[];return t.forEach(t=>{let i=[this.userId,eD(t.path)],s=IDBKeyRange.lowerBound(i),a=tT(e,eU).Z({range:s},(e,n,i)=>{let[s,a,o]=e,l=ek(a);s===this.userId&&t.path.isEqual(l)?r=r.add(o):i.done()});n.push(a)}),eu.waitFor(n).next(()=>this.kn(e,r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,n=r.length+1,i=[this.userId,eD(r)],s=IDBKeyRange.lowerBound(i),a=new tD(U);return tT(e,eU).Z({range:s},(e,t,i)=>{let[s,o,l]=e,u=ek(o);s===this.userId&&r.isPrefixOf(u)?u.length===n&&(a=a.add(l)):i.done()}).next(()=>this.kn(e,a))}kn(e,t){let r=[],n=[];return t.forEach(t=>{n.push(i5(e).get(t).next(e=>{if(null===e)throw S();e.userId===this.userId||S(),r.push(iv(this.serializer,e))}))}),eu.waitFor(n).next(()=>r)}removeMutationBatch(e,t){return iX(e.ue,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.qn(t.batchId)}),eu.forEach(r,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}qn(e){delete this.Bn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return eu.resolve();let r=IDBKeyRange.lowerBound([this.userId]),n=[];return tT(e,eU).Z({range:r},(e,t,r)=>{if(e[0]===this.userId){let t=ek(e[1]);n.push(t)}else r.done()}).next(()=>{0===n.length||S()})})}containsKey(e,t){return i2(e,this.userId,t)}Qn(e){return tT(e,eR).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function i2(e,t,r){let n=[t,eD(r.path)],i=n[1],s=IDBKeyRange.lowerBound(n),a=!1;return tT(e,eU).Z({range:s,Y:!0},(e,r,n)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),n.done()}).next(()=>a)}function i5(e){return tT(e,eO)}class i8{constructor(e){this.$n=e}next(){return this.$n+=2,this.$n}static Un(){return new i8(0)}static Kn(){return new i8(-1)}}class i3{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Wn(e).next(t=>{let r=new i8(t.highestTargetId);return t.highestTargetId=r.next(),this.Gn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Wn(e).next(e=>$.fromTimestamp(new K(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Wn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.Wn(e).next(n=>(n.highestListenSequenceNumber=t,r&&(n.lastRemoteSnapshotVersion=r.toTimestamp()),t>n.highestListenSequenceNumber&&(n.highestListenSequenceNumber=t),this.Gn(e,n)))}addTargetData(e,t){return this.zn(e,t).next(()=>this.Wn(e).next(r=>(r.targetCount+=1,this.jn(t,r),this.Gn(e,r))))}updateTargetData(e,t){return this.zn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tT(e,eH).delete(t.targetId)).next(()=>this.Wn(e)).next(t=>(t.targetCount>0||S(),t.targetCount-=1,this.Gn(e,t)))}removeTargets(e,t,r){let n=0,i=[];return tT(e,eH).Z((s,a)=>{let o=iI(a);o.sequenceNumber<=t&&null===r.get(o.targetId)&&(n++,i.push(this.removeTargetData(e,o)))}).next(()=>eu.waitFor(i)).next(()=>n)}forEachTarget(e,t){return tT(e,eH).Z((e,r)=>{t(iI(r))})}Wn(e){return tT(e,e2).get(e1).next(e=>(null!==e||S(),e))}Gn(e,t){return tT(e,e2).put(e1,t)}zn(e,t){return tT(e,eH).put(iT(this.serializer,t))}jn(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.Wn(e).next(e=>e.targetCount)}getTargetData(e,t){let r=rR(t),n=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),i=null;return tT(e,eH).Z({range:n,index:eW},(e,r,n)=>{let s=iI(r);rO(t,s.target)&&(i=s,n.done())}).next(()=>i)}addMatchingKeys(e,t,r){let n=[],i=i4(e);return t.forEach(t=>{let s=eD(t.path);n.push(i.put({targetId:r,path:s})),n.push(this.referenceDelegate.addReference(e,r,t))}),eu.waitFor(n)}removeMatchingKeys(e,t,r){let n=i4(e);return eu.forEach(t,t=>{let i=eD(t.path);return eu.waitFor([n.delete([r,i]),this.referenceDelegate.removeReference(e,r,t)])})}removeMatchingKeysForTargetId(e,t){let r=i4(e),n=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(n)}getMatchingKeysForTargetId(e,t){let r=IDBKeyRange.bound([t],[t+1],!1,!0),n=i4(e),i=r9();return n.Z({range:r,Y:!0},(e,t,r)=>{let n=new Y(ek(e[1]));i=i.add(n)}).next(()=>i)}containsKey(e,t){let r=eD(t.path),n=IDBKeyRange.bound([r],[r+"\0"],!1,!0),i=0;return i4(e).Z({index:eX,Y:!0,range:n},([e,t],r,n)=>{0!==e&&(i++,n.done())}).next(()=>i>0)}lt(e,t){return tT(e,eH).get(t).next(e=>e?iI(e):null)}}function i4(e){return tT(e,eZ)}let i6="LruGarbageCollector";function i9([e,t],[r,n]){let i=U(e,r);return 0===i?U(t,n):i}class i7{constructor(e){this.Hn=e,this.buffer=new tD(i9),this.Jn=0}Yn(){return++this.Jn}Zn(e){let t=[e,this.Yn()];if(this.buffer.size<this.Hn)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>i9(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class se{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.Xn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.er(6e4)}stop(){this.Xn&&(this.Xn.cancel(),this.Xn=null)}get started(){return null!==this.Xn}er(e){T(i6,`Garbage collection scheduled in ${e}ms`),this.Xn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Xn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ep(e)?T(i6,"Ignoring IndexedDB error during garbage collection: ",e):await el(e)}await this.er(3e5)})}}class st{constructor(e,t){this.tr=e,this.params=t}calculateTargetCount(e,t){return this.tr.nr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return eu.resolve(e_.ae);let r=new i7(t);return this.tr.forEachTarget(e,e=>r.Zn(e.sequenceNumber)).next(()=>this.tr.rr(e,e=>r.Zn(e))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.tr.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.tr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector","Garbage collection skipped; disabled"),eu.resolve(iZ)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),iZ):this.ir(e,t))}getCacheSize(e){return this.tr.getCacheSize(e)}ir(e,t){let r,n,i,s,a,o,l,h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(T("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),n=this.params.maximumSequenceNumbersToCollect):n=t,s=Date.now(),this.nthSequenceNumber(e,n))).next(n=>(r=n,a=Date.now(),this.removeTargets(e,r,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,r))).next(e=>(l=Date.now(),I()<=u.$b.DEBUG&&T("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-h}ms
	Determined least recently used ${n} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-h}ms`),eu.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:i,documentsRemoved:e})))}}class sr{constructor(e,t){this.db=e,this.garbageCollector=new st(this,t)}nr(e){let t=this.sr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}rr(e,t){return this._r(e,(e,r)=>t(r))}addReference(e,t,r){return sn(e,r)}removeReference(e,t,r){return sn(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return sn(e,t)}ar(e,t){let r;return r=!1,tT(e,eR).X(n=>i2(e,n,t).next(e=>(e&&(r=!0),eu.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(e,t){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),n=[],i=0;return this._r(e,(s,a)=>{if(a<=t){let t=this.ar(e,s).next(t=>{if(!t)return i++,r.getEntry(e,s).next(()=>(r.removeEntry(s,$.min()),i4(e).delete([0,eD(s.path)])))});n.push(t)}}).next(()=>eu.waitFor(n)).next(()=>r.apply(e)).next(()=>i)}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return sn(e,t)}_r(e,t){let r=i4(e),n,i=e_.ae;return r.Z({index:eX},([e,r],{path:s,sequenceNumber:a})=>{0===e?(i!==e_.ae&&t(new Y(ek(n)),i),i=a,n=s):i=e_.ae}).next(()=>{i!==e_.ae&&t(new Y(ek(n)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sn(e,t){var r;return i4(e).put((r=e.currentSequenceNumber,{targetId:0,path:eD(t.path),sequenceNumber:r}))}class si{constructor(){this.changes=new r0(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,rh.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return void 0!==r?eu.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class ss{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return tT(e,eq).put(r)}removeEntry(e,t,r){return tT(e,eq).delete(function(e,t){let r=e.path.toArray();return[r.slice(0,r.length-2),r[r.length-2],ip(t),r[r.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.ur(e,r)))}getEntry(e,t){let r=rh.newInvalidDocument(t);return tT(e,eq).Z({index:ez,range:IDBKeyRange.only(so(t))},(e,n)=>{r=this.cr(t,n)}).next(()=>r)}lr(e,t){let r={size:0,document:rh.newInvalidDocument(t)};return tT(e,eq).Z({index:ez,range:IDBKeyRange.only(so(t))},(e,n)=>{r={document:this.cr(t,n),size:i0(n)}}).next(()=>r)}getEntries(e,t){let r=r1;return this.hr(e,t,(e,t)=>{let n=this.cr(e,t);r=r.insert(e,n)}).next(()=>r)}Pr(e,t){let r=r1,n=new tS(Y.comparator);return this.hr(e,t,(e,t)=>{let i=this.cr(e,t);r=r.insert(e,i),n=n.insert(e,i0(t))}).next(()=>({documents:r,Tr:n}))}hr(e,t,r){if(t.isEmpty())return eu.resolve();let n=new tD(su);t.forEach(e=>n=n.add(e));let i=IDBKeyRange.bound(so(n.first()),so(n.last())),s=n.getIterator(),a=s.getNext();return tT(e,eq).Z({index:ez,range:i},(e,t,n)=>{let i=Y.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>su(a,i);)r(a,null),a=s.getNext();a&&a.isEqual(i)&&(r(a,t),a=s.hasNext()?s.getNext():null),a?n.W(so(a)):n.done()}).next(()=>{for(;a;)r(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,r,n,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),ip(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tT(e,eq).G(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let r=r1;for(let i of e){let e=this.cr(Y.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(rZ(t,e)||n.has(e.key))&&(r=r.insert(e.key,e))}return r})}getAllFromCollectionGroup(e,t,r,n){let i=r1,s=sl(t,r),a=sl(t,ei.max());return tT(e,eq).Z({index:e$,range:IDBKeyRange.bound(s,a,!0)},(e,t,r)=>{let s=this.cr(Y.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===n&&r.done()}).next(()=>i)}newChangeBuffer(e){return new sa(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tT(e,ej).get(eQ).next(e=>(e||S(),e))}ur(e,t){return tT(e,ej).put(eQ,t)}cr(e,t){if(t){let e=function(e,t){let r;if(t.document)r=ir(e.Tt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=Y.fromSegments(t.noDocument.path),n=iw(t.noDocument.readTime);r=rh.newNoDocument(e,n),t.hasCommittedMutations&&r.setHasCommittedMutations()}else{if(!t.unknownDocument)return S();{let e=Y.fromSegments(t.unknownDocument.path),n=iw(t.unknownDocument.version);r=rh.newUnknownDocument(e,n)}}return t.readTime&&r.setReadTime(function(e){let t=new K(e[0],e[1]);return $.fromTimestamp(t)}(t.readTime)),r}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual($.min())))return e}return rh.newInvalidDocument(e)}}class sa extends si{constructor(e,t){super(),this.Ir=e,this.trackRemovals=t,this.Er=new r0(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],r=0,n=new tD((e,t)=>U(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Er.get(i);if(t.push(this.Ir.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=ig(this.Ir.serializer,s);n=n.add(i.path.popLast());let l=i0(o);r+=l-a.size,t.push(this.Ir.addEntry(e,i,o))}else if(r-=a.size,this.trackRemovals){let r=ig(this.Ir.serializer,s.convertToNoDocument($.min()));t.push(this.Ir.addEntry(e,i,r))}}),n.forEach(r=>{t.push(this.Ir.indexManager.addToCollectionParentIndex(e,r))}),t.push(this.Ir.updateMetadata(e,r)),eu.waitFor(t)}getFromCache(e,t){return this.Ir.lr(e,t).next(e=>(this.Er.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Ir.Pr(e,t).next(({documents:e,Tr:t})=>(t.forEach((t,r)=>{this.Er.set(t,{size:r,readTime:e.get(t).readTime})}),e))}}function so(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function sl(e,t){let r=t.documentKey.path.toArray();return[e,ip(t.readTime),r.slice(0,r.length-2),r.length>0?r[r.length-1]:""]}function su(e,t){let r=e.path.toArray(),n=t.path.toArray(),i=0;for(let e=0;e<r.length-2&&e<n.length-2;++e)if(i=U(r[e],n[e]))return i;return(i=U(r.length,n.length))||(i=U(r[r.length-2],n[n.length-2]))||U(r[r.length-1],n[n.length-1])}class sh{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sc{constructor(e,t,r,n){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=n}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(n=>(r=n,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==r&&nv(r.mutation,e,tA.empty(),K.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,r9()).next(()=>t))}getLocalViewOfDocuments(e,t,r=r9()){let n=r3();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,r).next(e=>{let t=r5();return e.forEach((e,r)=>{t=t.insert(e,r.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let r=r3();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,r9()))}populateOverlays(e,t,r){let n=[];return r.forEach(e=>{t.has(e)||n.push(e)}),this.documentOverlayCache.getOverlays(e,n).next(e=>{e.forEach((e,r)=>{t.set(e,r)})})}computeViews(e,t,r,n){let i=r1,s=r3(),a=r3();return t.forEach((e,t)=>{let a=r.get(t.key);n.has(t.key)&&(void 0===a||a.mutation instanceof nE)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),nv(a.mutation,t,a.mutation.getFieldMask(),K.now())):s.set(t.key,tA.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var r;return a.set(e,new sh(t,null!=(r=s.get(e))?r:null))}),a))}recalculateAndSaveOverlays(e,t){let r=r3(),n=new tS((e,t)=>e-t),i=r9();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=r.get(e)||tA.empty();a=i.applyToLocalView(s,a),r.set(e,a);let o=(n.get(i.batchId)||r9()).add(e);n=n.insert(i.batchId,o)})}).next(()=>{let s=[],a=n.getReverseIterator();for(;a.hasNext();){let n=a.getNext(),o=n.key,l=n.value,u=r3();l.forEach(e=>{if(!i.has(e)){let n=nw(t.get(e),r.get(e));null!==n&&u.set(e,n),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return eu.waitFor(s)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,r,n){return Y.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):rz(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,n):this.getDocumentsMatchingCollectionQuery(e,t,r,n)}getNextDocuments(e,t,r,n){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,n).next(i=>{let s=n-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,n-i.size):eu.resolve(r3()),a=-1,o=i;return s.next(t=>eu.forEach(t,(t,r)=>(a<r.largestBatchId&&(a=r.largestBatchId),i.get(t)?eu.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,r9())).next(e=>({batchId:a,changes:r8(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Y(t)).next(e=>{let t=r5();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,r,n){let i=t.collectionGroup,s=r5();return this.indexManager.getCollectionParents(e,i).next(a=>eu.forEach(a,a=>{let o=new rU(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,r,n).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,r,n){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,i,n))).next(e=>{i.forEach((t,r)=>{let n=r.getKey();null===e.get(n)&&(e=e.insert(n,rh.newInvalidDocument(n)))});let r=r5();return e.forEach((e,n)=>{let s=i.get(e);void 0!==s&&nv(s.mutation,n,tA.empty(),K.now()),rZ(t,n)&&(r=r.insert(e,n))}),r})}}class sd{constructor(e){this.serializer=e,this.dr=new Map,this.Ar=new Map}getBundleMetadata(e,t){return eu.resolve(this.dr.get(t))}saveBundleMetadata(e,t){return this.dr.set(t.id,{id:t.id,version:t.version,createTime:n1(t.createTime)}),eu.resolve()}getNamedQuery(e,t){return eu.resolve(this.Ar.get(t))}saveNamedQuery(e,t){return this.Ar.set(t.name,{name:t.name,query:iE(t.bundledQuery),readTime:n1(t.readTime)}),eu.resolve()}}class sf{constructor(){this.overlays=new tS(Y.comparator),this.Rr=new Map}getOverlay(e,t){return eu.resolve(this.overlays.get(t))}getOverlays(e,t){let r=r3();return eu.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&r.set(t,e)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((r,n)=>{this.Et(e,t,n)}),eu.resolve()}removeOverlaysForBatchId(e,t,r){let n=this.Rr.get(r);return void 0!==n&&(n.forEach(e=>this.overlays=this.overlays.remove(e)),this.Rr.delete(r)),eu.resolve()}getOverlaysForCollection(e,t,r){let n=r3(),i=t.length+1,s=new Y(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>r&&n.set(e.getKey(),e)}return eu.resolve(n)}getOverlaysForCollectionGroup(e,t,r,n){let i=new tS((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>r){let t=i.get(e.largestBatchId);null===t&&(t=r3(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=r3(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=n)););return eu.resolve(a)}Et(e,t,r){let n=this.overlays.get(r.key);if(null!==n){let e=this.Rr.get(n.largestBatchId).delete(r.key);this.Rr.set(n.largestBatchId,e)}this.overlays=this.overlays.insert(r.key,new nC(t,r));let i=this.Rr.get(t);void 0===i&&(i=r9(),this.Rr.set(t,i)),this.Rr.set(t,i.add(r.key))}}class sm{constructor(){this.sessionToken=tR.EMPTY_BYTE_STRING}getSessionToken(e){return eu.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,eu.resolve()}}class sg{constructor(){this.Vr=new tD(sp.mr),this.gr=new tD(sp.pr)}isEmpty(){return this.Vr.isEmpty()}addReference(e,t){let r=new sp(e,t);this.Vr=this.Vr.add(r),this.gr=this.gr.add(r)}yr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.wr(new sp(e,t))}Sr(e,t){e.forEach(e=>this.removeReference(e,t))}br(e){let t=new Y(new Q([])),r=new sp(t,e),n=new sp(t,e+1),i=[];return this.gr.forEachInRange([r,n],e=>{this.wr(e),i.push(e.key)}),i}Dr(){this.Vr.forEach(e=>this.wr(e))}wr(e){this.Vr=this.Vr.delete(e),this.gr=this.gr.delete(e)}vr(e){let t=new Y(new Q([])),r=new sp(t,e),n=new sp(t,e+1),i=r9();return this.gr.forEachInRange([r,n],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sp(e,0),r=this.Vr.firstAfterOrEqual(t);return null!==r&&e.isEqual(r.key)}}class sp{constructor(e,t){this.key=e,this.Cr=t}static mr(e,t){return Y.comparator(e.key,t.key)||U(e.Cr,t.Cr)}static pr(e,t){return U(e.Cr,t.Cr)||Y.comparator(e.key,t.key)}}class sy{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Fr=1,this.Mr=new tD(sp.mr)}checkEmpty(e){return eu.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,r,n){let i=this.Fr;this.Fr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new nD(i,t,r,n);for(let t of(this.mutationQueue.push(s),n))this.Mr=this.Mr.add(new sp(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return eu.resolve(s)}lookupMutationBatch(e,t){return eu.resolve(this.Or(t))}getNextMutationBatchAfterBatchId(e,t){let r=this.Nr(t+1),n=r<0?0:r;return eu.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return eu.resolve(0===this.mutationQueue.length?-1:this.Fr-1)}getAllMutationBatches(e){return eu.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new sp(t,0),n=new sp(t,Number.POSITIVE_INFINITY),i=[];return this.Mr.forEachInRange([r,n],e=>{let t=this.Or(e.Cr);i.push(t)}),eu.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new tD(U);return t.forEach(e=>{let t=new sp(e,0),n=new sp(e,Number.POSITIVE_INFINITY);this.Mr.forEachInRange([t,n],e=>{r=r.add(e.Cr)})}),eu.resolve(this.Br(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,n=r.length+1,i=r;Y.isDocumentKey(i)||(i=i.child(""));let s=new sp(new Y(i),0),a=new tD(U);return this.Mr.forEachWhile(e=>{let t=e.key.path;return!!r.isPrefixOf(t)&&(t.length===n&&(a=a.add(e.Cr)),!0)},s),eu.resolve(this.Br(a))}Br(e){let t=[];return e.forEach(e=>{let r=this.Or(e);null!==r&&t.push(r)}),t}removeMutationBatch(e,t){0===this.Lr(t.batchId,"removed")||S(),this.mutationQueue.shift();let r=this.Mr;return eu.forEach(t.mutations,n=>{let i=new sp(n.key,t.batchId);return r=r.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,n.key)}).next(()=>{this.Mr=r})}qn(e){}containsKey(e,t){let r=new sp(t,0),n=this.Mr.firstAfterOrEqual(r);return eu.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,eu.resolve()}Lr(e,t){return this.Nr(e)}Nr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Or(e){let t=this.Nr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sw{constructor(e){this.kr=e,this.docs=new tS(Y.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,n=this.docs.get(r),i=n?n.size:0,s=this.kr(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return eu.resolve(r?r.document.mutableCopy():rh.newInvalidDocument(t))}getEntries(e,t){let r=r1;return t.forEach(e=>{let t=this.docs.get(e);r=r.insert(e,t?t.document.mutableCopy():rh.newInvalidDocument(e))}),eu.resolve(r)}getDocumentsMatchingQuery(e,t,r,n){let i=r1,s=t.path,a=new Y(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=es(en(a),r)||(n.has(a.key)||rZ(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return eu.resolve(i)}getAllFromCollectionGroup(e,t,r,n){S()}qr(e,t){return eu.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sv(this)}getSize(e){return eu.resolve(this.size)}}class sv extends si{constructor(e){super(),this.Ir=e}applyChanges(e){let t=[];return this.changes.forEach((r,n)=>{n.isValidDocument()?t.push(this.Ir.addEntry(e,n)):this.Ir.removeEntry(r)}),eu.waitFor(t)}getFromCache(e,t){return this.Ir.getEntry(e,t)}getAllFromCache(e,t){return this.Ir.getEntries(e,t)}}class sI{constructor(e){this.persistence=e,this.Qr=new r0(e=>rR(e),rO),this.lastRemoteSnapshotVersion=$.min(),this.highestTargetId=0,this.$r=0,this.Ur=new sg,this.targetCount=0,this.Kr=i8.Un()}forEachTarget(e,t){return this.Qr.forEach((e,r)=>t(r)),eu.resolve()}getLastRemoteSnapshotVersion(e){return eu.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return eu.resolve(this.$r)}allocateTargetId(e){return this.highestTargetId=this.Kr.next(),eu.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.$r&&(this.$r=t),eu.resolve()}zn(e){this.Qr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.Kr=new i8(t),this.highestTargetId=t),e.sequenceNumber>this.$r&&(this.$r=e.sequenceNumber)}addTargetData(e,t){return this.zn(t),this.targetCount+=1,eu.resolve()}updateTargetData(e,t){return this.zn(t),eu.resolve()}removeTargetData(e,t){return this.Qr.delete(t.target),this.Ur.br(t.targetId),this.targetCount-=1,eu.resolve()}removeTargets(e,t,r){let n=0,i=[];return this.Qr.forEach((s,a)=>{a.sequenceNumber<=t&&null===r.get(a.targetId)&&(this.Qr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),n++)}),eu.waitFor(i).next(()=>n)}getTargetCount(e){return eu.resolve(this.targetCount)}getTargetData(e,t){let r=this.Qr.get(t)||null;return eu.resolve(r)}addMatchingKeys(e,t,r){return this.Ur.yr(t,r),eu.resolve()}removeMatchingKeys(e,t,r){this.Ur.Sr(t,r);let n=this.persistence.referenceDelegate,i=[];return n&&t.forEach(t=>{i.push(n.markPotentiallyOrphaned(e,t))}),eu.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Ur.br(t),eu.resolve()}getMatchingKeysForTargetId(e,t){let r=this.Ur.vr(t);return eu.resolve(r)}containsKey(e,t){return eu.resolve(this.Ur.containsKey(t))}}class sT{constructor(e,t){this.Wr={},this.overlays={},this.Gr=new e_(0),this.zr=!1,this.zr=!0,this.jr=new sm,this.referenceDelegate=e(this),this.Hr=new sI(this),this.indexManager=new iG,this.remoteDocumentCache=new sw(e=>this.referenceDelegate.Jr(e)),this.serializer=new im(t),this.Yr=new sd(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.zr=!1,Promise.resolve()}get started(){return this.zr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sf,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.Wr[e.toKey()];return r||(r=new sy(t,this.referenceDelegate),this.Wr[e.toKey()]=r),r}getGlobalsCache(){return this.jr}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Yr}runTransaction(e,t,r){T("MemoryPersistence","Starting transaction:",e);let n=new sE(this.Gr.next());return this.referenceDelegate.Zr(),r(n).next(e=>this.referenceDelegate.Xr(n).next(()=>e)).toPromise().then(e=>(n.raiseOnCommittedEvent(),e))}ei(e,t){return eu.or(Object.values(this.Wr).map(r=>()=>r.containsKey(e,t)))}}class sE extends eo{constructor(e){super(),this.currentSequenceNumber=e}}class sb{constructor(e){this.persistence=e,this.ti=new sg,this.ni=null}static ri(e){return new sb(e)}get ii(){if(this.ni)return this.ni;throw S()}addReference(e,t,r){return this.ti.addReference(r,t),this.ii.delete(r.toString()),eu.resolve()}removeReference(e,t,r){return this.ti.removeReference(r,t),this.ii.add(r.toString()),eu.resolve()}markPotentiallyOrphaned(e,t){return this.ii.add(t.toString()),eu.resolve()}removeTarget(e,t){this.ti.br(t.targetId).forEach(e=>this.ii.add(e.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.ii.add(e.toString()))}).next(()=>r.removeTargetData(e,t))}Zr(){this.ni=new Set}Xr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return eu.forEach(this.ii,r=>{let n=Y.fromPath(r);return this.si(e,n).next(e=>{e||t.removeEntry(n,$.min())})}).next(()=>(this.ni=null,t.apply(e)))}updateLimboDocument(e,t){return this.si(e,t).next(e=>{e?this.ii.delete(t.toString()):this.ii.add(t.toString())})}Jr(e){return 0}si(e,t){return eu.or([()=>eu.resolve(this.ti.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.ei(e,t)])}}class s_{constructor(e,t){this.persistence=e,this.oi=new r0(e=>eD(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new st(this,t)}static ri(e,t){return new s_(e,t)}Zr(){}Xr(e){return eu.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}nr(e){let t=this.sr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}rr(e,t){return eu.forEach(this.oi,(r,n)=>this.ar(e,r,n).next(e=>e?eu.resolve():t(n)))}removeTargets(e,t,r){return this.persistence.getTargetCache().removeTargets(e,t,r)}removeOrphanedDocuments(e,t){let r=0,n=this.persistence.getRemoteDocumentCache(),i=n.newChangeBuffer();return n.qr(e,n=>this.ar(e,n,t).next(e=>{e||(r++,i.removeEntry(n,$.min()))})).next(()=>i.apply(e)).next(()=>r)}markPotentiallyOrphaned(e,t){return this.oi.set(t,e.currentSequenceNumber),eu.resolve()}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,r)}addReference(e,t,r){return this.oi.set(r,e.currentSequenceNumber),eu.resolve()}removeReference(e,t,r){return this.oi.set(r,e.currentSequenceNumber),eu.resolve()}updateLimboDocument(e,t){return this.oi.set(t,e.currentSequenceNumber),eu.resolve()}Jr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(t0(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let r=tK(t);return r?16+e(r):16;case 5:return 2*t.stringValue.length;case 6:return tF(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,r)=>t+e(r),0);case 10:case 11:var n;let i;return n=t.mapValue,i=0,tb(n.fields,(t,r)=>{i+=t.length+e(r)}),i;default:throw S()}}(e.data.value)),t}ar(e,t,r){return eu.or([()=>this.persistence.ei(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.oi.get(t);return eu.resolve(void 0!==e&&e>r)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sS{constructor(e){this.serializer=e}B(e,t,r,n){let i=new ec("createOrUpgrade",t);r<1&&n>=1&&(e.createObjectStore(eA),e.createObjectStore(eR,{keyPath:"userId"}),e.createObjectStore(eO,{keyPath:eM,autoIncrement:!0}).createIndex(eL,eF,{unique:!0}),e.createObjectStore(eU),sx(e),e.createObjectStore(eC));let s=eu.resolve();return r<3&&n>=3&&(0!==r&&(e.deleteObjectStore(eZ),e.deleteObjectStore(eH),e.deleteObjectStore(e2),sx(e)),s=s.next(()=>(function(e){let t=e.store(e2),r={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:$.min().toTimestamp(),targetCount:0};return t.put(e1,r)})(i))),r<4&&n>=4&&(0!==r&&(s=s.next(()=>i.store(eO).G().next(t=>{e.deleteObjectStore(eO),e.createObjectStore(eO,{keyPath:eM,autoIncrement:!0}).createIndex(eL,eF,{unique:!0});let r=i.store(eO),n=t.map(e=>r.put(e));return eu.waitFor(n)}))),s=s.next(()=>{e.createObjectStore(e3,{keyPath:"clientId"})})),r<5&&n>=5&&(s=s.next(()=>this._i(i))),r<6&&n>=6&&(s=s.next(()=>(e.createObjectStore(ej),this.ai(i)))),r<7&&n>=7&&(s=s.next(()=>this.ui(i))),r<8&&n>=8&&(s=s.next(()=>this.ci(e,i))),r<9&&n>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),r<10&&n>=10&&(s=s.next(()=>this.li(i))),r<11&&n>=11&&(s=s.next(()=>{e.createObjectStore(e4,{keyPath:"bundleId"}),e.createObjectStore(e6,{keyPath:"name"})})),r<12&&n>=12&&(s=s.next(()=>{let t=e.createObjectStore(tl,{keyPath:tu});t.createIndex(th,tc,{unique:!1}),t.createIndex(td,tf,{unique:!1})})),r<13&&n>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(eq,{keyPath:eB});t.createIndex(ez,eK),t.createIndex(e$,eG)})(e)).next(()=>this.hi(e,i)).next(()=>e.deleteObjectStore(eC))),r<14&&n>=14&&(s=s.next(()=>this.Pi(e,i))),r<15&&n>=15&&(s=s.next(()=>{e.createObjectStore(e9,{keyPath:"indexId",autoIncrement:!0}).createIndex(e7,"collectionGroup",{unique:!1}),e.createObjectStore(te,{keyPath:tt}).createIndex(tr,tn,{unique:!1}),e.createObjectStore(ti,{keyPath:ts}).createIndex(ta,to,{unique:!1})})),r<16&&n>=16&&(s=s.next(()=>{t.objectStore(te).clear()}).next(()=>{t.objectStore(ti).clear()})),r<17&&n>=17&&(s=s.next(()=>{e.createObjectStore(tm,{keyPath:"name"})})),s}ai(e){let t=0;return e.store(eC).Z((e,r)=>{t+=i0(r)}).next(()=>{let r={byteSize:t};return e.store(ej).put(eQ,r)})}_i(e){let t=e.store(eR),r=e.store(eO);return t.G().next(t=>eu.forEach(t,t=>{let n=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.G(eL,n).next(r=>eu.forEach(r,r=>{r.userId===t.userId||S();let n=iv(this.serializer,r);return iX(e,t.userId,n).next(()=>{})}))}))}ui(e){let t=e.store(eZ),r=e.store(eC);return e.store(e2).get(e1).next(e=>{let n=[];return r.Z((r,i)=>{let s=new Q(r),a=[0,eD(s)];n.push(t.get(a).next(r=>r?eu.resolve():t.put({targetId:0,path:eD(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>eu.waitFor(n))})}ci(e,t){e.createObjectStore(e5,{keyPath:e8});let r=t.store(e5),n=new ij,i=e=>{if(n.add(e)){let t=e.lastSegment(),n=e.popLast();return r.put({collectionId:t,parent:eD(n)})}};return t.store(eC).Z({Y:!0},(e,t)=>i(new Q(e).popLast())).next(()=>t.store(eU).Z({Y:!0},([e,t,r],n)=>i(ek(t).popLast())))}li(e){let t=e.store(eH);return t.Z((e,r)=>{let n=iI(r),i=iT(this.serializer,n);return t.put(i)})}hi(e,t){let r=t.store(eC),n=[];return r.Z((e,r)=>{let i=t.store(eq),s=(r.document?new Y(Q.fromString(r.document.name).popFirst(5)):r.noDocument?Y.fromSegments(r.noDocument.path):r.unknownDocument?Y.fromSegments(r.unknownDocument.path):S()).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:r.readTime||[0,0],unknownDocument:r.unknownDocument,noDocument:r.noDocument,document:r.document,hasCommittedMutations:!!r.hasCommittedMutations};n.push(i.put(a))}).next(()=>eu.waitFor(n))}Pi(e,t){let r=t.store(eO),n=new ss(this.serializer),i=new sT(sb.ri,this.serializer.Tt);return r.G().next(e=>{let r=new Map;return e.forEach(e=>{var t;let n=null!=(t=r.get(e.userId))?t:r9();iv(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),eu.forEach(r,(e,r)=>{let s=new y(r),a=iN.It(this.serializer,s),o=i.getIndexManager(s);return new sc(n,i1.It(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tI(t,e_.ae),e).next()})})}}function sx(e){e.createObjectStore(eZ,{keyPath:eJ}).createIndex(eX,e0,{unique:!0}),e.createObjectStore(eH,{keyPath:"targetId"}).createIndex(eW,eY,{unique:!0}),e.createObjectStore(e2)}let sN="IndexedDbPersistence",sD="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class sk{constructor(e,t,r,n,i,s,a,o,l,u,h=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.Ti=i,this.window=s,this.document=a,this.Ii=l,this.Ei=u,this.di=h,this.Gr=null,this.zr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ai=null,this.inForeground=!1,this.Ri=null,this.Vi=null,this.mi=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!sk.D())throw new N(x.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new sr(this,n),this.gi=t+"main",this.serializer=new im(o),this.pi=new ed(this.gi,this.di,new sS(this.serializer)),this.jr=new iD,this.Hr=new i3(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new ss(this.serializer),this.Yr=new ix,this.window&&this.window.localStorage?this.yi=this.window.localStorage:(this.yi=null,!1===u&&E(sN,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new N(x.FAILED_PRECONDITION,sD);return this.Si(),this.bi(),this.Di(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Hr.getHighestSequenceNumber(e))}).then(e=>{this.Gr=new e_(e,this.Ii)}).then(()=>{this.zr=!0}).catch(e=>(this.pi&&this.pi.close(),Promise.reject(e)))}Ci(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.pi.k(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ti.enqueueAndForget(async()=>{this.started&&await this.wi()}))}wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tT(e,e3).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Fi(e).next(e=>{e||(this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)))})}).next(()=>this.Mi(e)).next(t=>this.isPrimary&&!t?this.xi(e).next(()=>!1):!!t&&this.Oi(e).next(()=>!0))).catch(e=>{if(ep(e))return T(sN,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return T(sN,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Ti.enqueueRetryable(()=>this.fi(e)),this.isPrimary=e})}Fi(e){return tT(e,eA).get(eV).next(e=>eu.resolve(this.Ni(e)))}Bi(e){return tT(e,e3).delete(this.clientId)}async Li(){if(this.isPrimary&&!this.ki(this.mi,18e5)){this.mi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tT(e,e3);return t.G().next(e=>{let r=this.qi(e,18e5),n=e.filter(e=>-1===r.indexOf(e));return eu.forEach(n,e=>t.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.yi)for(let t of e)this.yi.removeItem(this.Qi(t.clientId))}}Di(){this.Vi=this.Ti.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.wi().then(()=>this.Li()).then(()=>this.Di()))}Ni(e){return!!e&&e.ownerId===this.clientId}Mi(e){return this.Ei?eu.resolve(!0):tT(e,eA).get(eV).next(t=>{if(null!==t&&this.ki(t.leaseTimestampMs,5e3)&&!this.$i(t.ownerId)){if(this.Ni(t)&&this.networkEnabled)return!0;if(!this.Ni(t)){if(!t.allowTabSynchronization)throw new N(x.FAILED_PRECONDITION,sD);return!1}}return!(!this.networkEnabled||!this.inForeground)||tT(e,e3).G().next(e=>void 0===this.qi(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,r=!this.inForeground&&e.inForeground,n=this.networkEnabled===e.networkEnabled;if(t||r&&n)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&T(sN,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.zr=!1,this.Ui(),this.Vi&&(this.Vi.cancel(),this.Vi=null),this.Ki(),this.Wi(),await this.pi.runTransaction("shutdown","readwrite",[eA,e3],e=>{let t=new tI(e,e_.ae);return this.xi(t).next(()=>this.Bi(t))}),this.pi.close(),this.Gi()}qi(e,t){return e.filter(e=>this.ki(e.updateTimeMs,t)&&!this.$i(e.clientId))}zi(){return this.runTransaction("getActiveClients","readonly",e=>tT(e,e3).G().next(e=>this.qi(e,18e5).map(e=>e.clientId)))}get started(){return this.zr}getGlobalsCache(){return this.jr}getMutationQueue(e,t){return i1.It(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new iW(e,this.serializer.Tt.databaseId)}getDocumentOverlayCache(e){return iN.It(this.serializer,e)}getBundleCache(){return this.Yr}runTransaction(e,t,r){var n;let i;T(sN,"Starting transaction:",e);let s=17===(n=this.di)?tv:16===n||15===n?tw:14===n||13===n?ty:12===n?tp:11===n?tg:void S();return this.pi.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,n=>(i=new tI(n,this.Gr?this.Gr.next():e_.ae),"readwrite-primary"===t?this.Fi(i).next(e=>!!e||this.Mi(i)).next(t=>{if(!t)throw E(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)),new N(x.FAILED_PRECONDITION,ea);return r(i)}).next(e=>this.Oi(i).next(()=>e)):this.ji(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}ji(e){return tT(e,eA).get(eV).next(e=>{if(null!==e&&this.ki(e.leaseTimestampMs,5e3)&&!this.$i(e.ownerId)&&!this.Ni(e)&&!(this.Ei||this.allowTabSynchronization&&e.allowTabSynchronization))throw new N(x.FAILED_PRECONDITION,sD)})}Oi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tT(e,eA).put(eV,t)}static D(){return ed.D()}xi(e){let t=tT(e,eA);return t.get(eV).next(e=>this.Ni(e)?(T(sN,"Releasing primary lease."),t.delete(eV)):eu.resolve())}ki(e,t){let r=Date.now();return!(e<r-t)&&(!(e>r)||(E(`Detected an update time that is in the future: ${e} > ${r}`),!1))}Si(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ri=()=>{this.Ti.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.wi()))},this.document.addEventListener("visibilitychange",this.Ri),this.inForeground="visible"===this.document.visibilityState)}Ki(){this.Ri&&(this.document.removeEventListener("visibilitychange",this.Ri),this.Ri=null)}bi(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.Ai=()=>{this.Ui();let e=/(?:Version|Mobile)\/1[456]/;(0,h.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ti.enterRestrictedMode(!0),this.Ti.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Ai))}Wi(){this.Ai&&(this.window.removeEventListener("pagehide",this.Ai),this.Ai=null)}$i(e){var t;try{let r=null!==(null==(t=this.yi)?void 0:t.getItem(this.Qi(e)));return T(sN,`Client '${e}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(e){return E(sN,"Failed to get zombied client id.",e),!1}}Ui(){if(this.yi)try{this.yi.setItem(this.Qi(this.clientId),String(Date.now()))}catch(e){E("Failed to set zombie client id.",e)}}Gi(){if(this.yi)try{this.yi.removeItem(this.Qi(this.clientId))}catch(e){}}Qi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function sC(e,t){let r=e.projectId;return e.isDefaultDatabase||(r+="."+e.database),"firestore/"+t+"/"+r+"/"}class sA{constructor(e,t,r,n){this.targetId=e,this.fromCache=t,this.Hi=r,this.Ji=n}static Yi(e,t){let r=r9(),n=r9();for(let e of t.docChanges)switch(e.type){case 0:r=r.add(e.doc.key);break;case 1:n=n.add(e.doc.key)}return new sA(e,t.fromCache,r,n)}}class sV{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class sR{constructor(){this.Zi=!1,this.Xi=!1,this.es=100,this.ts=(0,h.nr)()?8:ef((0,h.ZQ)())>0?6:4}initialize(e,t){this.ns=e,this.indexManager=t,this.Zi=!0}getDocumentsMatchingQuery(e,t,r,n){let i={result:null};return this.rs(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ss(e,t,n,r).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let r=new sV;return this._s(e,t,r).next(n=>{if(i.result=n,this.Xi)return this.us(e,t,r,n.size)})}).next(()=>i.result)}us(e,t,r,n){return r.documentReadCount<this.es?(I()<=u.$b.DEBUG&&T("QueryEngine","SDK will not create cache indexes for query:",rY(t),"since it only creates cache indexes for collection contains","more than or equal to",this.es,"documents"),eu.resolve()):(I()<=u.$b.DEBUG&&T("QueryEngine","Query:",rY(t),"scans",r.documentReadCount,"local documents and returns",n,"documents as results."),r.documentReadCount>this.ts*n?(I()<=u.$b.DEBUG&&T("QueryEngine","The SDK decides to create cache indexes for query:",rY(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,r$(t))):eu.resolve())}rs(e,t){if(rB(t))return eu.resolve(null);let r=r$(t);return this.indexManager.getIndexType(e,r).next(n=>0===n?null:(null!==t.limit&&1===n&&(r=r$(t=rQ(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,r).next(n=>{let i=r9(...n);return this.ns.getDocuments(e,i).next(n=>this.indexManager.getMinOffset(e,r).next(r=>{let s=this.cs(t,n);return this.ls(t,s,i,r.readTime)?this.rs(e,rQ(t,null,"F")):this.hs(e,s,t,r)}))})))}ss(e,t,r,n){return rB(t)||n.isEqual($.min())?eu.resolve(null):this.ns.getDocuments(e,r).next(i=>{let s=this.cs(t,i);return this.ls(t,s,r,n)?eu.resolve(null):(I()<=u.$b.DEBUG&&T("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),rY(t)),this.hs(e,s,t,er(n,-1)).next(e=>e))})}cs(e,t){let r=new tD(rX(e));return t.forEach((t,n)=>{rZ(e,n)&&(r=r.add(n))}),r}ls(e,t,r,n){if(null===e.limit)return!1;if(r.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(n)>0)}_s(e,t,r){return I()<=u.$b.DEBUG&&T("QueryEngine","Using full collection scan to execute query:",rY(t)),this.ns.getDocumentsMatchingQuery(e,t,ei.min(),r)}hs(e,t,r,n){return this.ns.getDocumentsMatchingQuery(e,r,n).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let sO="LocalStore";class sM{constructor(e,t,r,n){this.persistence=e,this.Ps=t,this.serializer=n,this.Ts=new tS(U),this.Is=new r0(e=>rR(e),rO),this.Es=new Map,this.ds=e.getRemoteDocumentCache(),this.Hr=e.getTargetCache(),this.Yr=e.getBundleCache(),this.As(r)}As(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sc(this.ds,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ds.setIndexManager(this.indexManager),this.Ps.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ts))}}async function sL(e,t){return await e.persistence.runTransaction("Handle user change","readonly",r=>{let n;return e.mutationQueue.getAllMutationBatches(r).next(i=>(n=i,e.As(t),e.mutationQueue.getAllMutationBatches(r))).next(t=>{let i=[],s=[],a=r9();for(let e of n)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(r,a).next(e=>({Rs:e,removedBatchIds:i,addedBatchIds:s}))})})}function sF(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Hr.getLastRemoteSnapshotVersion(t))}function sP(e,t,r){let n=r9(),i=r9();return r.forEach(e=>n=n.add(e)),t.getEntries(e,n).next(e=>{let n=r1;return r.forEach((r,s)=>{let a=e.get(r);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(r)),s.isNoDocument()&&s.version.isEqual($.min())?(t.removeEntry(r,s.readTime),n=n.insert(r,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),n=n.insert(r,s)):T(sO,"Ignoring outdated watch update for ",r,". Current version:",a.version," Watch version:",s.version)}),{Vs:n,fs:i}})}function sU(e,t){return e.persistence.runTransaction("Allocate target","readwrite",r=>{let n;return e.Hr.getTargetData(r,t).next(i=>i?(n=i,eu.resolve(n)):e.Hr.allocateTargetId(r).next(i=>(n=new id(t,i,"TargetPurposeListen",r.currentSequenceNumber),e.Hr.addTargetData(r,n).next(()=>n))))}).then(r=>{let n=e.Ts.get(r.targetId);return(null===n||r.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Ts=e.Ts.insert(r.targetId,r),e.Is.set(t,r.targetId)),r})}async function sq(e,t,r){let n=e.Ts.get(t);try{r||await e.persistence.runTransaction("Release target",r?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,n))}catch(e){if(!ep(e))throw e;T(sO,`Failed to update sequence numbers for target ${t}: ${e}`)}e.Ts=e.Ts.remove(t),e.Is.delete(n.target)}function sB(e,t,r){let n=$.min(),i=r9();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,r){let n=e.Is.get(r);return void 0!==n?eu.resolve(e.Ts.get(n)):e.Hr.getTargetData(t,r)})(e,s,r$(t)).next(t=>{if(t)return n=t.lastLimboFreeSnapshotVersion,e.Hr.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Ps.getDocumentsMatchingQuery(s,t,r?n:$.min(),r?i:r9())).next(r=>(s$(e,rJ(t),r),{documents:r,gs:i})))}function sz(e,t){let r=e.Hr,n=e.Ts.get(t);return n?Promise.resolve(n.target):e.persistence.runTransaction("Get target data","readonly",e=>r.lt(e,t).next(e=>e?e.target:null))}function sK(e,t){let r=e.Es.get(t)||$.min();return e.persistence.runTransaction("Get new document changes","readonly",n=>e.ds.getAllFromCollectionGroup(n,t,er(r,-1),Number.MAX_SAFE_INTEGER)).then(r=>(s$(e,t,r),r))}function s$(e,t,r){let n=e.Es.get(t)||$.min();r.forEach((e,t)=>{t.readTime.compareTo(n)>0&&(n=t.readTime)}),e.Es.set(t,n)}async function sG(e,t,r,n){let i=r9(),s=r1;for(let e of r){let r=t.ps(e.metadata.name);e.document&&(i=i.add(r));let n=t.ys(e);n.setReadTime(t.ws(e.metadata.readTime)),s=s.insert(r,n)}let a=e.ds.newChangeBuffer({trackRemovals:!0}),o=await sU(e,r$(rq(Q.fromString(`__bundle__/docs/${n}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>sP(t,a,s).next(e=>(a.apply(t),e)).next(r=>e.Hr.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Hr.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,r.Vs,r.fs)).next(()=>r.Vs)))}async function sj(e,t,r=r9()){let n=await sU(e,r$(iE(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=n1(t.readTime);if(n.snapshotVersion.compareTo(s)>=0)return e.Yr.saveNamedQuery(i,t);let a=n.withResumeToken(tR.EMPTY_BYTE_STRING,s);return e.Ts=e.Ts.insert(a.targetId,a),e.Hr.updateTargetData(i,a).next(()=>e.Hr.removeMatchingKeysForTargetId(i,n.targetId)).next(()=>e.Hr.addMatchingKeys(i,r,n.targetId)).next(()=>e.Yr.saveNamedQuery(i,t))})}let sQ="firestore_clients";function sH(e,t){return`${sQ}_${e}_${t}`}let sW="firestore_mutations";function sY(e,t,r){let n=`${sW}_${e}_${r}`;return t.isAuthenticated()&&(n+=`_${t.uid}`),n}let sZ="firestore_targets";function sJ(e,t){return`${sZ}_${e}_${t}`}let sX="SharedClientState";class s0{constructor(e,t,r,n){this.user=e,this.batchId=t,this.state=r,this.error=n}static Ss(e,t,r){let n=JSON.parse(r),i,s="object"==typeof n&&-1!==["pending","acknowledged","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new N(n.error.code,n.error.message)),s?new s0(e,t,n.state,i):(E(sX,`Failed to parse mutation state for ID '${t}': ${r}`),null)}bs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class s1{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static Ss(e,t){let r=JSON.parse(t),n,i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(n=new N(r.error.code,r.error.message)),i?new s1(e,r.state,n):(E(sX,`Failed to parse target state for ID '${e}': ${t}`),null)}bs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class s2{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ss(e,t){let r=JSON.parse(t),n="object"==typeof r&&r.activeTargetIds instanceof Array,i=r7;for(let e=0;n&&e<r.activeTargetIds.length;++e)n=eN(r.activeTargetIds[e]),i=i.add(r.activeTargetIds[e]);return n?new s2(e,i):(E(sX,`Failed to parse client data for instance '${e}': ${t}`),null)}}class s5{constructor(e,t){this.clientId=e,this.onlineState=t}static Ss(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new s5(t.clientId,t.onlineState):(E(sX,`Failed to parse online state: ${e}`),null)}}class s8{constructor(){this.activeTargetIds=r7}Ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}vs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}bs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class s3{constructor(e,t,r,n,i){var s,a,o;this.window=e,this.Ti=t,this.persistenceKey=r,this.Cs=n,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Fs=this.Ms.bind(this),this.xs=new tS(U),this.started=!1,this.Os=[];let l=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Ns=sH(this.persistenceKey,this.Cs),this.Bs=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.xs=this.xs.insert(this.Cs,new s8),this.Ls=RegExp(`^${sQ}_${l}_([^_]*)$`),this.ks=RegExp(`^${sW}_${l}_(\\d+)(?:_(.*))?$`),this.qs=RegExp(`^${sZ}_${l}_(\\d+)$`),this.Qs=(a=this.persistenceKey,`firestore_online_state_${a}`),this.$s=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Fs)}static D(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.zi())){if(e===this.Cs)continue;let t=this.getItem(sH(this.persistenceKey,e));if(t){let r=s2.Ss(e,t);r&&(this.xs=this.xs.insert(r.clientId,r))}}this.Us();let e=this.storage.getItem(this.Qs);if(e){let t=this.Ks(e);t&&this.Ws(t)}for(let e of this.Os)this.Ms(e);this.Os=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Bs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Gs(this.xs)}isActiveQueryTarget(e){let t=!1;return this.xs.forEach((r,n)=>{n.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.zs(e,"pending")}updateMutationState(e,t,r){this.zs(e,t,r),this.js(e)}addLocalQueryTarget(e,t=!0){let r="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(sJ(this.persistenceKey,e));if(t){let n=s1.Ss(e,t);n&&(r=n.state)}}return t&&this.Hs.Ds(e),this.Us(),r}removeLocalQueryTarget(e){this.Hs.vs(e),this.Us()}isLocalQueryTarget(e){return this.Hs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(sJ(this.persistenceKey,e))}updateQueryState(e,t,r){this.Js(e,t,r)}handleUserChange(e,t,r){t.forEach(e=>{this.js(e)}),this.currentUser=e,r.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ys(e)}notifyBundleLoaded(e){this.Zs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Fs),this.removeItem(this.Ns),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return T(sX,"READ",e,t),t}setItem(e,t){T(sX,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){T(sX,"REMOVE",e),this.storage.removeItem(e)}Ms(e){if(e.storageArea===this.storage){if(T(sX,"EVENT",e.key,e.newValue),e.key===this.Ns)return void E("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ti.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.Ls.test(e.key)){if(null==e.newValue){let t=this.Xs(e.key);return this.eo(t,null)}{let t=this.no(e.key,e.newValue);if(t)return this.eo(t.clientId,t)}}else if(this.ks.test(e.key)){if(null!==e.newValue){let t=this.ro(e.key,e.newValue);if(t)return this.io(t)}}else if(this.qs.test(e.key)){if(null!==e.newValue){let t=this.so(e.key,e.newValue);if(t)return this.oo(t)}}else if(e.key===this.Qs){if(null!==e.newValue){let t=this.Ks(e.newValue);if(t)return this.Ws(t)}}else if(e.key===this.Bs){let t=function(e){let t=e_.ae;if(null!=e)try{let r=JSON.parse(e);"number"==typeof r||S(),t=r}catch(e){E(sX,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==e_.ae&&this.sequenceNumberHandler(t)}else if(e.key===this.$s){let t=this._o(e.newValue);await Promise.all(t.map(e=>this.syncEngine.ao(e)))}}}else this.Os.push(e)})}}get Hs(){return this.xs.get(this.Cs)}Us(){this.setItem(this.Ns,this.Hs.bs())}zs(e,t,r){let n=new s0(this.currentUser,e,t,r),i=sY(this.persistenceKey,this.currentUser,e);this.setItem(i,n.bs())}js(e){let t=sY(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ys(e){let t={clientId:this.Cs,onlineState:e};this.storage.setItem(this.Qs,JSON.stringify(t))}Js(e,t,r){let n=sJ(this.persistenceKey,e),i=new s1(e,t,r);this.setItem(n,i.bs())}Zs(e){let t=JSON.stringify(Array.from(e));this.setItem(this.$s,t)}Xs(e){let t=this.Ls.exec(e);return t?t[1]:null}no(e,t){let r=this.Xs(e);return s2.Ss(r,t)}ro(e,t){let r=this.ks.exec(e),n=Number(r[1]),i=void 0!==r[2]?r[2]:null;return s0.Ss(new y(i),n,t)}so(e,t){let r=Number(this.qs.exec(e)[1]);return s1.Ss(r,t)}Ks(e){return s5.Ss(e)}_o(e){return JSON.parse(e)}async io(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.uo(e.batchId,e.state,e.error);T(sX,`Ignoring mutation for non-active user ${e.user.uid}`)}oo(e){return this.syncEngine.co(e.targetId,e.state,e.error)}eo(e,t){let r=t?this.xs.insert(e,t):this.xs.remove(e),n=this.Gs(this.xs),i=this.Gs(r),s=[],a=[];return i.forEach(e=>{n.has(e)||s.push(e)}),n.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.lo(s,a).then(()=>{this.xs=r})}Ws(e){this.xs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Gs(e){let t=r7;return e.forEach((e,r)=>{t=t.unionWith(r.activeTargetIds)}),t}}class s4{constructor(){this.ho=new s8,this.Po={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e,t=!0){return t&&this.ho.Ds(e),this.Po[e]||"not-current"}updateQueryState(e,t,r){this.Po[e]=t}removeLocalQueryTarget(e){this.ho.vs(e)}isLocalQueryTarget(e){return this.ho.activeTargetIds.has(e)}clearQueryState(e){delete this.Po[e]}getAllActiveQueryTargets(){return this.ho.activeTargetIds}isActiveQueryTarget(e){return this.ho.activeTargetIds.has(e)}start(){return this.ho=new s8,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class s6{To(e){}shutdown(){}}let s9="ConnectivityMonitor";class s7{constructor(){this.Io=()=>this.Eo(),this.Ao=()=>this.Ro(),this.Vo=[],this.mo()}To(e){this.Vo.push(e)}shutdown(){window.removeEventListener("online",this.Io),window.removeEventListener("offline",this.Ao)}mo(){window.addEventListener("online",this.Io),window.addEventListener("offline",this.Ao)}Eo(){for(let e of(T(s9,"Network connectivity changed: AVAILABLE"),this.Vo))e(0)}Ro(){for(let e of(T(s9,"Network connectivity changed: UNAVAILABLE"),this.Vo))e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let ae=null;function at(){return null===ae?ae=0x10000000+Math.round(0x80000000*Math.random()):ae++,"0x"+ae.toString(16)}let ar="RestConnection",an={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class ai{get fo(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",r=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.po=t+"://"+e.host,this.yo=`projects/${r}/databases/${n}`,this.wo=this.databaseId.database===tj?`project_id=${r}`:`project_id=${r}&database_id=${n}`}So(e,t,r,n,i){let s=at(),a=this.bo(e,t.toUriEncodedString());T(ar,`Sending RPC '${e}' ${s}:`,a,r);let o={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Do(o,n,i),this.vo(e,a,o,r).then(t=>(T(ar,`Received RPC '${e}' ${s}: `,t),t),t=>{throw b(ar,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",r),t})}Co(e,t,r,n,i,s){return this.So(e,t,r,n,i)}Do(e,t,r){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,r)=>e[r]=t),r&&r.headers.forEach((t,r)=>e[r]=t)}bo(e,t){let r=an[e];return`${this.po}/v1/${t}:${r}`}terminate(){}}class as{constructor(e){this.Fo=e.Fo,this.Mo=e.Mo}xo(e){this.Oo=e}No(e){this.Bo=e}Lo(e){this.ko=e}onMessage(e){this.qo=e}close(){this.Mo()}send(e){this.Fo(e)}Qo(){this.Oo()}$o(){this.Bo()}Uo(e){this.ko(e)}Ko(e){this.qo(e)}}let aa="WebChannelConnection";class ao extends ai{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}vo(e,t,r,n){let i=at();return new Promise((s,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();T(aa,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case d.O4.TIMEOUT:T(aa,`RPC '${e}' ${i} timed out`),a(new N(x.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let r=o.getStatus();if(T(aa,`RPC '${e}' ${i} failed with status:`,r,"response text:",o.getResponseText()),r>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=null==e?void 0:e.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(x).indexOf(t)>=0?t:x.UNKNOWN}(t.status);a(new N(e,t.message))}else a(new N(x.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new N(x.UNAVAILABLE,"Connection failed."));break;default:S()}}finally{T(aa,`RPC '${e}' ${i} completed.`)}});let l=JSON.stringify(n);T(aa,`RPC '${e}' ${i} sending request:`,n),o.send(t,"POST",l,r,15)})}Wo(e,t,r){let i=at(),s=[this.po,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Do(l.initMessageHeaders,t,r),l.encodeInitMessageHeaders=!0;let h=s.join("");T(aa,`Creating RPC '${e}' stream ${i}: ${h}`,l);let c=a.createWebChannel(h,l),f=!1,m=!1,g=new as({Fo:t=>{m?T(aa,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(T(aa,`Opening RPC '${e}' stream ${i} transport.`),c.open(),f=!0),T(aa,`RPC '${e}' stream ${i} sending:`,t),c.send(t))},Mo:()=>c.close()}),p=(e,t,r)=>{e.listen(t,e=>{try{r(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(c,d.iO.EventType.OPEN,()=>{m||(T(aa,`RPC '${e}' stream ${i} transport opened.`),g.Qo())}),p(c,d.iO.EventType.CLOSE,()=>{m||(m=!0,T(aa,`RPC '${e}' stream ${i} transport closed`),g.Uo())}),p(c,d.iO.EventType.ERROR,t=>{m||(m=!0,b(aa,`RPC '${e}' stream ${i} transport errored:`,t),g.Uo(new N(x.UNAVAILABLE,"The operation could not be completed")))}),p(c,d.iO.EventType.MESSAGE,t=>{var r;if(!m){let s=t.data[0];s||S();let a=(null==s?void 0:s.error)||(null==(r=s[0])?void 0:r.error);if(a){T(aa,`RPC '${e}' stream ${i} received error:`,a);let t=a.status,r=function(e){let t=n[e];if(void 0!==t)return nR(t)}(t),s=a.message;void 0===r&&(r=x.INTERNAL,s="Unknown error status: "+t+" with message "+a.message),m=!0,g.Uo(new N(r,s)),c.close()}else T(aa,`RPC '${e}' stream ${i} received:`,s),g.Ko(s)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?T(aa,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&T(aa,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.$o()},0),g}}function al(){return"undefined"!=typeof window?window:null}function au(){return"undefined"!=typeof document?document:null}function ah(e){return new nZ(e,!0)}class ac{constructor(e,t,r=1e3,n=1.5,i=6e4){this.Ti=e,this.timerId=t,this.Go=r,this.zo=n,this.jo=i,this.Ho=0,this.Jo=null,this.Yo=Date.now(),this.reset()}reset(){this.Ho=0}Zo(){this.Ho=this.jo}Xo(e){this.cancel();let t=Math.floor(this.Ho+this.e_()),r=Math.max(0,Date.now()-this.Yo),n=Math.max(0,t-r);n>0&&T("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.Ho} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.Jo=this.Ti.enqueueAfterDelay(this.timerId,n,()=>(this.Yo=Date.now(),e())),this.Ho*=this.zo,this.Ho<this.Go&&(this.Ho=this.Go),this.Ho>this.jo&&(this.Ho=this.jo)}t_(){null!==this.Jo&&(this.Jo.skipDelay(),this.Jo=null)}cancel(){null!==this.Jo&&(this.Jo.cancel(),this.Jo=null)}e_(){return(Math.random()-.5)*this.Ho}}let ad="PersistentStream";class af{constructor(e,t,r,n,i,s,a,o){this.Ti=e,this.n_=r,this.r_=n,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.i_=0,this.s_=null,this.o_=null,this.stream=null,this.__=0,this.a_=new ac(e,t)}u_(){return 1===this.state||5===this.state||this.c_()}c_(){return 2===this.state||3===this.state}start(){this.__=0,4!==this.state?this.auth():this.l_()}async stop(){this.u_()&&await this.close(0)}h_(){this.state=0,this.a_.reset()}P_(){this.c_()&&null===this.s_&&(this.s_=this.Ti.enqueueAfterDelay(this.n_,6e4,()=>this.T_()))}I_(e){this.E_(),this.stream.send(e)}async T_(){if(this.c_())return this.close(0)}E_(){this.s_&&(this.s_.cancel(),this.s_=null)}d_(){this.o_&&(this.o_.cancel(),this.o_=null)}async close(e,t){this.E_(),this.d_(),this.a_.cancel(),this.i_++,4!==e?this.a_.reset():t&&t.code===x.RESOURCE_EXHAUSTED?(E(t.toString()),E("Using maximum backoff delay to prevent overloading the backend."),this.a_.Zo()):t&&t.code===x.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.A_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Lo(t)}A_(){}auth(){this.state=1;let e=this.R_(this.i_),t=this.i_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,r])=>{this.i_===t&&this.V_(e,r)},t=>{e(()=>{let e=new N(x.UNKNOWN,"Fetching auth token failed: "+t.message);return this.m_(e)})})}V_(e,t){let r=this.R_(this.i_);this.stream=this.f_(e,t),this.stream.xo(()=>{r(()=>this.listener.xo())}),this.stream.No(()=>{r(()=>(this.state=2,this.o_=this.Ti.enqueueAfterDelay(this.r_,1e4,()=>(this.c_()&&(this.state=3),Promise.resolve())),this.listener.No()))}),this.stream.Lo(e=>{r(()=>this.m_(e))}),this.stream.onMessage(e=>{r(()=>1==++this.__?this.g_(e):this.onNext(e))})}l_(){this.state=5,this.a_.Xo(async()=>{this.state=0,this.start()})}m_(e){return T(ad,`close with error: ${e}`),this.stream=null,this.close(4,e)}R_(e){return t=>{this.Ti.enqueueAndForget(()=>this.i_===e?t():(T(ad,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class am extends af{constructor(e,t,r,n,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,n,s),this.serializer=i}f_(e,t){return this.connection.Wo("Listen",e,t)}g_(e){return this.onNext(e)}onNext(e){this.a_.reset();let t=function(e,t){let r;if("targetChange"in t){var n,i;t.targetChange;let s="NO_CHANGE"===(n=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===n?1:"REMOVE"===n?2:"CURRENT"===n?3:"RESET"===n?4:S(),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(void 0===i||"string"==typeof i||S(),tR.fromBase64String(i||"")):(void 0===i||i instanceof m||i instanceof Uint8Array||S(),tR.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;r=new nK(s,a,o,l&&new N(void 0===l.code?x.UNKNOWN:nR(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let n=t.documentChange;n.document,n.document.name,n.document.updateTime;let i=n4(e,n.document.name),s=n1(n.document.updateTime),a=n.document.createTime?n1(n.document.createTime):$.min(),o=new ru({mapValue:{fields:n.document.fields}}),l=rh.newFoundDocument(i,s,a,o);r=new nB(n.targetIds||[],n.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let n=t.documentDelete;n.document;let i=n4(e,n.document),s=n.readTime?n1(n.readTime):$.min(),a=rh.newNoDocument(i,s);r=new nB([],n.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let n=t.documentRemove;n.document;let i=n4(e,n.document);r=new nB([],n.removedTargetIds||[],i,null)}else{if(!("filter"in t))return S();{t.filter;let e=t.filter;e.targetId;let{count:n=0,unchangedNames:i}=e,s=new nA(n,i);r=new nz(e.targetId,s)}}return r}(this.serializer,e),r=function(e){if(!("targetChange"in e))return $.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?$.min():t.readTime?n1(t.readTime):$.min()}(e);return this.listener.p_(t,r)}y_(e){let t={};t.database=n7(this.serializer),t.addTarget=function(e,t){let r,n=t.target;if((r=rM(n)?{documents:ia(e,n)}:{query:io(e,n).ht}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){r.resumeToken=n0(e,t.resumeToken);let n=nJ(e,t.expectedCount);null!==n&&(r.expectedCount=n)}else if(t.snapshotVersion.compareTo($.min())>0){r.readTime=nX(e,t.snapshotVersion.toTimestamp());let n=nJ(e,t.expectedCount);null!==n&&(r.expectedCount=n)}return r}(this.serializer,e);let r=function(e,t){let r=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return S()}}(t.purpose);return null==r?null:{"goog-listen-tags":r}}(this.serializer,e);r&&(t.labels=r),this.I_(t)}w_(e){let t={};t.database=n7(this.serializer),t.removeTarget=e,this.I_(t)}}class ag extends af{constructor(e,t,r,n,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,n,s),this.serializer=i}get S_(){return this.__>0}start(){this.lastStreamToken=void 0,super.start()}A_(){this.S_&&this.b_([])}f_(e,t){return this.connection.Wo("Write",e,t)}g_(e){return e.streamToken||S(),this.lastStreamToken=e.streamToken,e.writeResults&&0!==e.writeResults.length&&S(),this.listener.D_()}onNext(e){var t,r;e.streamToken||S(),this.lastStreamToken=e.streamToken,this.a_.reset();let n=(t=e.writeResults,r=e.commitTime,t&&t.length>0?(void 0!==r||S(),t.map(e=>{let t;return(t=e.updateTime?n1(e.updateTime):n1(r)).isEqual($.min())&&(t=n1(r)),new nm(t,e.transformResults||[])})):[]),i=n1(e.commitTime);return this.listener.v_(i,n)}C_(){let e={};e.database=n7(this.serializer),this.I_(e)}b_(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>ii(this.serializer,e))};this.I_(t)}}class ap{}class ay extends ap{constructor(e,t,r,n){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=n,this.F_=!1}M_(){if(this.F_)throw new N(x.FAILED_PRECONDITION,"The client has already been terminated.")}So(e,t,r,n){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.So(e,n5(t,r),n,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===x.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(x.UNKNOWN,e.toString())})}Co(e,t,r,n,i){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Co(e,n5(t,r),n,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===x.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(x.UNKNOWN,e.toString())})}terminate(){this.F_=!0,this.connection.terminate()}}class aw{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.x_=0,this.O_=null,this.N_=!0}B_(){0===this.x_&&(this.L_("Unknown"),this.O_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.O_=null,this.k_("Backend didn't respond within 10 seconds."),this.L_("Offline"),Promise.resolve())))}q_(e){"Online"===this.state?this.L_("Unknown"):(this.x_++,this.x_>=1&&(this.Q_(),this.k_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.L_("Offline")))}set(e){this.Q_(),this.x_=0,"Online"===e&&(this.N_=!1),this.L_(e)}L_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}k_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.N_?(E(t),this.N_=!1):T("OnlineStateTracker",t)}Q_(){null!==this.O_&&(this.O_.cancel(),this.O_=null)}}let av="RemoteStore";class aI{constructor(e,t,r,n,i){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.U_=[],this.K_=new Map,this.W_=new Set,this.G_=[],this.z_=i,this.z_.To(e=>{r.enqueueAndForget(async()=>{ak(this)&&(T(av,"Restarting streams for network reachability change."),await async function(e){e.W_.add(4),await aE(e),e.j_.set("Unknown"),e.W_.delete(4),await aT(e)}(this))})}),this.j_=new aw(r,n)}}async function aT(e){if(ak(e))for(let t of e.G_)await t(!0)}async function aE(e){for(let t of e.G_)await t(!1)}function ab(e,t){e.K_.has(t.targetId)||(e.K_.set(t.targetId,t),aD(e)?aN(e):aG(e).c_()&&aS(e,t))}function a_(e,t){let r=aG(e);e.K_.delete(t),r.c_()&&ax(e,t),0===e.K_.size&&(r.c_()?r.P_():ak(e)&&e.j_.set("Unknown"))}function aS(e,t){if(e.H_.Ne(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo($.min())>0){let r=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(r)}aG(e).y_(t)}function ax(e,t){e.H_.Ne(t),aG(e).w_(t)}function aN(e){e.H_=new nG({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),lt:t=>e.K_.get(t)||null,it:()=>e.datastore.serializer.databaseId}),aG(e).start(),e.j_.B_()}function aD(e){return ak(e)&&!aG(e).u_()&&e.K_.size>0}function ak(e){return 0===e.W_.size}async function aC(e){e.j_.set("Online")}async function aA(e){e.K_.forEach((t,r)=>{aS(e,t)})}async function aV(e,t){e.H_=void 0,aD(e)?(e.j_.q_(t),aN(e)):e.j_.set("Unknown")}async function aR(e,t,r){if(e.j_.set("Online"),t instanceof nK&&2===t.state&&t.cause)try{await async function(e,t){let r=t.cause;for(let n of t.targetIds)e.K_.has(n)&&(await e.remoteSyncer.rejectListen(n,r),e.K_.delete(n),e.H_.removeTarget(n))}(e,t)}catch(r){T(av,"Failed to remove targets %s: %s ",t.targetIds.join(","),r),await aO(e,r)}else if(t instanceof nB?e.H_.We(t):t instanceof nz?e.H_.Ze(t):e.H_.je(t),!r.isEqual($.min()))try{let t=await sF(e.localStore);r.compareTo(t)>=0&&await function(e,t){let r=e.H_.ot(t);return r.targetChanges.forEach((r,n)=>{if(r.resumeToken.approximateByteSize()>0){let i=e.K_.get(n);i&&e.K_.set(n,i.withResumeToken(r.resumeToken,t))}}),r.targetMismatches.forEach((t,r)=>{let n=e.K_.get(t);if(!n)return;e.K_.set(t,n.withResumeToken(tR.EMPTY_BYTE_STRING,n.snapshotVersion)),ax(e,t);let i=new id(n.target,t,r,n.sequenceNumber);aS(e,i)}),e.remoteSyncer.applyRemoteEvent(r)}(e,r)}catch(t){T(av,"Failed to raise snapshot:",t),await aO(e,t)}}async function aO(e,t,r){if(!ep(t))throw t;e.W_.add(1),await aE(e),e.j_.set("Offline"),r||(r=()=>sF(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{T(av,"Retrying IndexedDB access"),await r(),e.W_.delete(1),await aT(e)})}function aM(e,t){return t().catch(r=>aO(e,r,t))}async function aL(e){var t;let r=aj(e),n=e.U_.length>0?e.U_[e.U_.length-1].batchId:-1;for(;ak(t=e)&&t.U_.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",r=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(r,t)))}(e.localStore,n);if(null===t){0===e.U_.length&&r.P_();break}n=t.batchId,function(e,t){e.U_.push(t);let r=aj(e);r.c_()&&r.S_&&r.b_(t.mutations)}(e,t)}catch(t){await aO(e,t)}aF(e)&&aP(e)}function aF(e){return ak(e)&&!aj(e).u_()&&e.U_.length>0}function aP(e){aj(e).start()}async function aU(e){aj(e).C_()}async function aq(e){let t=aj(e);for(let r of e.U_)t.b_(r.mutations)}async function aB(e,t,r){let n=e.U_.shift(),i=nk.from(n,t,r);await aM(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await aL(e)}async function az(e,t){t&&aj(e).S_&&await async function(e,t){var r;if(nV(r=t.code)&&r!==x.ABORTED){let r=e.U_.shift();aj(e).h_(),await aM(e,()=>e.remoteSyncer.rejectFailedWrite(r.batchId,t)),await aL(e)}}(e,t),aF(e)&&aP(e)}async function aK(e,t){e.asyncQueue.verifyOperationInProgress(),T(av,"RemoteStore received new credentials");let r=ak(e);e.W_.add(3),await aE(e),r&&e.j_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.W_.delete(3),await aT(e)}async function a$(e,t){t?(e.W_.delete(2),await aT(e)):t||(e.W_.add(2),await aE(e),e.j_.set("Unknown"))}function aG(e){var t,r,n;return e.J_||(t=e.datastore,r=e.asyncQueue,n={xo:aC.bind(null,e),No:aA.bind(null,e),Lo:aV.bind(null,e),p_:aR.bind(null,e)},t.M_(),e.J_=new am(r,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,n),e.G_.push(async t=>{t?(e.J_.h_(),aD(e)?aN(e):e.j_.set("Unknown")):(await e.J_.stop(),e.H_=void 0)})),e.J_}function aj(e){var t,r,n;return e.Y_||(t=e.datastore,r=e.asyncQueue,n={xo:()=>Promise.resolve(),No:aU.bind(null,e),Lo:az.bind(null,e),D_:aq.bind(null,e),v_:aB.bind(null,e)},t.M_(),e.Y_=new ag(r,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,n),e.G_.push(async t=>{t?(e.Y_.h_(),await aL(e)):(await e.Y_.stop(),e.U_.length>0&&(T(av,`Stopping write stream with ${e.U_.length} pending writes`),e.U_=[]))})),e.Y_}class aQ{constructor(e,t,r,n,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=n,this.removalCallback=i,this.deferred=new D,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,n,i){let s=new aQ(e,t,Date.now()+r,n,i);return s.start(r),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new N(x.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function aH(e,t){if(E("AsyncQueue",`${t}: ${e}`),ep(e))return new N(x.UNAVAILABLE,`${t}: ${e}`);throw e}class aW{static emptySet(e){return new aW(e.comparator)}constructor(e){this.comparator=e?(t,r)=>e(t,r)||Y.comparator(t.key,r.key):(e,t)=>Y.comparator(e.key,t.key),this.keyedMap=r5(),this.sortedSet=new tS(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof aW)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,n=r.getNext().key;if(!e.isEqual(n))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let r=new aW;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}}class aY{constructor(){this.Z_=new tS(Y.comparator)}track(e){let t=e.doc.key,r=this.Z_.get(t);r?0!==e.type&&3===r.type?this.Z_=this.Z_.insert(t,e):3===e.type&&1!==r.type?this.Z_=this.Z_.insert(t,{type:r.type,doc:e.doc}):2===e.type&&2===r.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===r.type?this.Z_=this.Z_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===r.type?this.Z_=this.Z_.remove(t):1===e.type&&2===r.type?this.Z_=this.Z_.insert(t,{type:1,doc:r.doc}):0===e.type&&1===r.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):S():this.Z_=this.Z_.insert(t,e)}X_(){let e=[];return this.Z_.inorderTraversal((t,r)=>{e.push(r)}),e}}class aZ{constructor(e,t,r,n,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=n,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,r,n,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new aZ(e,t,aW.emptySet(t),s,r,n,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&rH(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==r[e].type||!t[e].doc.isEqual(r[e].doc))return!1;return!0}}class aJ{constructor(){this.ea=void 0,this.ta=[]}na(){return this.ta.some(e=>e.ra())}}class aX{constructor(){this.queries=a0(),this.onlineState="Unknown",this.ia=new Set}terminate(){!function(e,t){let r=e.queries;e.queries=a0(),r.forEach((e,r)=>{for(let e of r.ta)e.onError(t)})}(this,new N(x.ABORTED,"Firestore shutting down"))}}function a0(){return new r0(e=>rW(e),rH)}async function a1(e,t){let r=3,n=t.query,i=e.queries.get(n);i?!i.na()&&t.ra()&&(r=2):(i=new aJ,r=+!t.ra());try{switch(r){case 0:i.ea=await e.onListen(n,!0);break;case 1:i.ea=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(r){let e=aH(r,`Initialization of query '${rY(t.query)}' failed`);return void t.onError(e)}e.queries.set(n,i),i.ta.push(t),t.sa(e.onlineState),i.ea&&t.oa(i.ea)&&a3(e)}async function a2(e,t){let r=t.query,n=3,i=e.queries.get(r);if(i){let e=i.ta.indexOf(t);e>=0&&(i.ta.splice(e,1),0===i.ta.length?n=+!t.ra():!i.na()&&t.ra()&&(n=2))}switch(n){case 0:return e.queries.delete(r),e.onUnlisten(r,!0);case 1:return e.queries.delete(r),e.onUnlisten(r,!1);case 2:return e.onLastRemoteStoreUnlisten(r);default:return}}function a5(e,t){let r=!1;for(let n of t){let t=n.query,i=e.queries.get(t);if(i){for(let e of i.ta)e.oa(n)&&(r=!0);i.ea=n}}r&&a3(e)}function a8(e,t,r){let n=e.queries.get(t);if(n)for(let e of n.ta)e.onError(r);e.queries.delete(t)}function a3(e){e.ia.forEach(e=>{e.next()})}(a=s||(s={}))._a="default",a.Cache="cache";class a4{constructor(e,t,r){this.query=e,this.aa=t,this.ua=!1,this.ca=null,this.onlineState="Unknown",this.options=r||{}}oa(e){if(!this.options.includeMetadataChanges){let t=[];for(let r of e.docChanges)3!==r.type&&t.push(r);e=new aZ(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.ua?this.la(e)&&(this.aa.next(e),t=!0):this.ha(e,this.onlineState)&&(this.Pa(e),t=!0),this.ca=e,t}onError(e){this.aa.error(e)}sa(e){this.onlineState=e;let t=!1;return this.ca&&!this.ua&&this.ha(this.ca,e)&&(this.Pa(this.ca),t=!0),t}ha(e,t){return!(e.fromCache&&this.ra())||(!this.options.Ta||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}la(e){if(e.docChanges.length>0)return!0;let t=this.ca&&this.ca.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Pa(e){e=aZ.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.ua=!0,this.aa.next(e)}ra(){return this.options.source!==s.Cache}}class a6{constructor(e,t){this.Ia=e,this.byteLength=t}Ea(){return"metadata"in this.Ia}}class a9{constructor(e){this.serializer=e}ps(e){return n4(this.serializer,e)}ys(e){return e.metadata.exists?ir(this.serializer,e.document,!1):rh.newNoDocument(this.ps(e.metadata.name),this.ws(e.metadata.readTime))}ws(e){return n1(e)}}class a7{constructor(e){this.key=e}}class oe{constructor(e){this.key=e}}class ot{constructor(e,t){this.query=e,this.fa=t,this.ga=null,this.hasCachedResults=!1,this.current=!1,this.pa=r9(),this.mutatedKeys=r9(),this.ya=rX(e),this.wa=new aW(this.ya)}get Sa(){return this.fa}ba(e,t){let r=t?t.Da:new aY,n=t?t.wa:this.wa,i=t?t.mutatedKeys:this.mutatedKeys,s=n,a=!1,o="F"===this.query.limitType&&n.size===this.query.limit?n.last():null,l="L"===this.query.limitType&&n.size===this.query.limit?n.first():null;if(e.inorderTraversal((e,t)=>{let u=n.get(e),h=rZ(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(r.track({type:3,doc:h}),f=!0):this.va(u,h)||(r.track({type:2,doc:h}),f=!0,(o&&this.ya(h,o)>0||l&&0>this.ya(h,l))&&(a=!0)):!u&&h?(r.track({type:0,doc:h}),f=!0):u&&!h&&(r.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),r.track({type:1,doc:e})}return{wa:s,Da:r,ls:a,mutatedKeys:i}}va(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,n){let i=this.wa;this.wa=e.wa,this.mutatedKeys=e.mutatedKeys;let s=e.Da.X_();s.sort((e,t)=>(function(e,t){let r=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return S()}};return r(e)-r(t)})(e.type,t.type)||this.ya(e.doc,t.doc)),this.Ca(r),n=null!=n&&n;let a=t&&!n?this.Fa():[],o=0===this.pa.size&&this.current&&!n?1:0,l=o!==this.ga;return(this.ga=o,0!==s.length||l)?{snapshot:new aZ(this.query,e.wa,i,s,e.mutatedKeys,0===o,l,!1,!!r&&r.resumeToken.approximateByteSize()>0),Ma:a}:{Ma:a}}sa(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({wa:this.wa,Da:new aY,mutatedKeys:this.mutatedKeys,ls:!1},!1)):{Ma:[]}}xa(e){return!this.fa.has(e)&&!!this.wa.has(e)&&!this.wa.get(e).hasLocalMutations}Ca(e){e&&(e.addedDocuments.forEach(e=>this.fa=this.fa.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.fa=this.fa.delete(e)),this.current=e.current)}Fa(){if(!this.current)return[];let e=this.pa;this.pa=r9(),this.wa.forEach(e=>{this.xa(e.key)&&(this.pa=this.pa.add(e.key))});let t=[];return e.forEach(e=>{this.pa.has(e)||t.push(new oe(e))}),this.pa.forEach(r=>{e.has(r)||t.push(new a7(r))}),t}Oa(e){this.fa=e.gs,this.pa=r9();let t=this.ba(e.documents);return this.applyChanges(t,!0)}Na(){return aZ.fromInitialDocuments(this.query,this.wa,this.mutatedKeys,0===this.ga,this.hasCachedResults)}}let or="SyncEngine";class on{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}}class oi{constructor(e){this.key=e,this.Ba=!1}}class os{constructor(e,t,r,n,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=n,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.La={},this.ka=new r0(e=>rW(e),rH),this.qa=new Map,this.Qa=new Set,this.$a=new tS(Y.comparator),this.Ua=new Map,this.Ka=new sg,this.Wa={},this.Ga=new Map,this.za=i8.Kn(),this.onlineState="Unknown",this.ja=void 0}get isPrimaryClient(){return!0===this.ja}}async function oa(e,t,r=!0){let n,i=oL(e),s=i.ka.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),n=s.view.Na()):n=await ol(i,t,r,!0),n}async function oo(e,t){let r=oL(e);await ol(r,t,!0,!1)}async function ol(e,t,r,n){let i,s=await sU(e.localStore,r$(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,r);return n&&(i=await ou(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&r&&ab(e.remoteStore,s),i}async function ou(e,t,r,n,i){e.Ha=(t,r,n)=>(async function(e,t,r,n){let i=t.view.ba(r);i.ls&&(i=await sB(e.localStore,t.query,!1).then(({documents:e})=>t.view.ba(e,i)));let s=n&&n.targetChanges.get(t.targetId),a=n&&null!=n.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return oE(e,t.targetId,o.Ma),o.snapshot})(e,t,r,n);let s=await sB(e.localStore,t,!0),a=new ot(t,s.gs),o=a.ba(s.documents),l=nq.createSynthesizedTargetChangeForCurrentChange(r,n&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);oE(e,r,u.Ma);let h=new on(t,r,a);return e.ka.set(t,h),e.qa.has(r)?e.qa.get(r).push(t):e.qa.set(r,[t]),u.snapshot}async function oh(e,t,r){let n=e.ka.get(t),i=e.qa.get(n.targetId);if(i.length>1)return e.qa.set(n.targetId,i.filter(e=>!rH(e,t))),void e.ka.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(n.targetId),e.sharedClientState.isActiveQueryTarget(n.targetId)||await sq(e.localStore,n.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(n.targetId),r&&a_(e.remoteStore,n.targetId),oI(e,n.targetId)}).catch(el)):(oI(e,n.targetId),await sq(e.localStore,n.targetId,!0))}async function oc(e,t){let r=e.ka.get(t),n=e.qa.get(r.targetId);e.isPrimaryClient&&1===n.length&&(e.sharedClientState.removeLocalQueryTarget(r.targetId),a_(e.remoteStore,r.targetId))}async function od(e,t,r){let n=oF(e);try{var i;let e,s=await function(e,t){let r,n,i=K.now(),s=t.reduce((e,t)=>e.add(t.key),r9());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=r1,l=r9();return e.ds.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(n=>{r=n;let s=[];for(let e of t){let t=function(e,t){let r=null;for(let n of e.fieldTransforms){let e=t.data.field(n.field),i=ni(n.transform,e||null);null!=i&&(null===r&&(r=ru.empty()),r.set(n.field,i))}return r||null}(e,r.get(e.key).overlayedDocument);null!=t&&s.push(new nE(e.key,t,function e(t){let r=[];return tb(t.fields,(t,n)=>{let i=new W([t]);if(rr(n)){let t=e(n.mapValue).fields;if(0===t.length)r.push(i);else for(let e of t)r.push(i.child(e))}else r.push(i)}),new tA(r)}(t.value.mapValue),ng.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{n=t;let i=t.applyToLocalDocumentSet(r,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:n.batchId,changes:r8(r)}))}(n.localStore,t);n.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=n.Wa[n.currentUser.toKey()])||(e=new tS(U)),e=e.insert(i,r),n.Wa[n.currentUser.toKey()]=e,await o_(n,s.changes),await aL(n.remoteStore)}catch(t){let e=aH(t,"Failed to persist write");r.reject(e)}}async function of(e,t){try{let r=await function(e,t){let r=t.snapshotVersion,n=e.Ts;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.ds.newChangeBuffer({trackRemovals:!0});n=e.Ts;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=n.get(o);if(!u)return;a.push(e.Hr.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Hr.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(tR.EMPTY_BYTE_STRING,$.min()).withLastLimboFreeSnapshotVersion($.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,r)),n=n.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Hr.updateTargetData(i,h))});let o=r1,l=r9();if(t.documentUpdates.forEach(r=>{t.resolvedLimboDocuments.has(r)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,r))}),a.push(sP(i,s,t.documentUpdates).next(e=>{o=e.Vs,l=e.fs})),!r.isEqual($.min())){let t=e.Hr.getLastRemoteSnapshotVersion(i).next(t=>e.Hr.setTargetsMetadata(i,i.currentSequenceNumber,r));a.push(t)}return eu.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.Ts=n,t))}(e.localStore,t);t.targetChanges.forEach((t,r)=>{let n=e.Ua.get(r);n&&(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1||S(),t.addedDocuments.size>0?n.Ba=!0:t.modifiedDocuments.size>0?n.Ba||S():t.removedDocuments.size>0&&(n.Ba||S(),n.Ba=!1))}),await o_(e,r,t)}catch(e){await el(e)}}function om(e,t,r){var n;if(e.isPrimaryClient&&0===r||!e.isPrimaryClient&&1===r){let r,i=[];e.ka.forEach((e,r)=>{let n=r.view.sa(t);n.snapshot&&i.push(n.snapshot)}),(n=e.eventManager).onlineState=t,r=!1,n.queries.forEach((e,n)=>{for(let e of n.ta)e.sa(t)&&(r=!0)}),r&&a3(n),i.length&&e.La.p_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function og(e,t,r){e.sharedClientState.updateQueryState(t,"rejected",r);let n=e.Ua.get(t),i=n&&n.key;if(i){let r=new tS(Y.comparator);r=r.insert(i,rh.newNoDocument(i,$.min()));let n=r9().add(i),s=new nU($.min(),new Map,new tS(U),r,n);await of(e,s),e.$a=e.$a.remove(i),e.Ua.delete(t),ob(e)}else await sq(e.localStore,t,!1).then(()=>oI(e,t,r)).catch(el)}async function op(e,t){var r;let n=t.batch.batchId;try{let i=await (r=e.localStore,r.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let n=t.batch.keys(),i=r.ds.newChangeBuffer({trackRemovals:!0});return(function(e,t,r,n){let i=r.batch,s=i.keys(),a=eu.resolve();return s.forEach(e=>{a=a.next(()=>n.getEntry(t,e)).next(t=>{let s=r.docVersions.get(e);null!==s||S(),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,r),t.isValidDocument()&&(t.setReadTime(r.commitVersion),n.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(r,e,t,i).next(()=>i.apply(e)).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t.batch.batchId)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=r9();for(let r=0;r<e.mutationResults.length;++r)e.mutationResults[r].transformResults.length>0&&(t=t.add(e.batch.mutations[r].key));return t}(t))).next(()=>r.localDocuments.getDocuments(e,n))}));ov(e,n,null),ow(e,n),e.sharedClientState.updateMutationState(n,"acknowledged"),await o_(e,i)}catch(e){await el(e)}}async function oy(e,t,r){var n;try{let i=await (n=e.localStore,n.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next(t=>(null!==t||S(),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t))).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r)).next(()=>n.localDocuments.getDocuments(e,r))}));ov(e,t,r),ow(e,t),e.sharedClientState.updateMutationState(t,"rejected",r),await o_(e,i)}catch(e){await el(e)}}function ow(e,t){(e.Ga.get(t)||[]).forEach(e=>{e.resolve()}),e.Ga.delete(t)}function ov(e,t,r){let n=e.Wa[e.currentUser.toKey()];if(n){let i=n.get(t);i&&(r?i.reject(r):i.resolve(),n=n.remove(t)),e.Wa[e.currentUser.toKey()]=n}}function oI(e,t,r=null){for(let n of(e.sharedClientState.removeLocalQueryTarget(t),e.qa.get(t)))e.ka.delete(n),r&&e.La.Ja(n,r);e.qa.delete(t),e.isPrimaryClient&&e.Ka.br(t).forEach(t=>{e.Ka.containsKey(t)||oT(e,t)})}function oT(e,t){e.Qa.delete(t.path.canonicalString());let r=e.$a.get(t);null!==r&&(a_(e.remoteStore,r),e.$a=e.$a.remove(t),e.Ua.delete(r),ob(e))}function oE(e,t,r){for(let n of r)n instanceof a7?(e.Ka.addReference(n.key,t),function(e,t){let r=t.key,n=r.path.canonicalString();e.$a.get(r)||e.Qa.has(n)||(T(or,"New document in limbo: "+r),e.Qa.add(n),ob(e))}(e,n)):n instanceof oe?(T(or,"Document no longer in limbo: "+n.key),e.Ka.removeReference(n.key,t),e.Ka.containsKey(n.key)||oT(e,n.key)):S()}function ob(e){for(;e.Qa.size>0&&e.$a.size<e.maxConcurrentLimboResolutions;){let t=e.Qa.values().next().value;e.Qa.delete(t);let r=new Y(Q.fromString(t)),n=e.za.next();e.Ua.set(n,new oi(r)),e.$a=e.$a.insert(r,n),ab(e.remoteStore,new id(r$(rq(r.path)),n,"TargetPurposeLimboResolution",e_.ae))}}async function o_(e,t,r){let n=[],i=[],s=[];e.ka.isEmpty()||(e.ka.forEach((a,o)=>{s.push(e.Ha(o,t,r).then(t=>{var s;if((t||r)&&e.isPrimaryClient){let n=t?!t.fromCache:null==(s=null==r?void 0:r.targetChanges.get(o.targetId))?void 0:s.current;e.sharedClientState.updateQueryState(o.targetId,n?"current":"not-current")}if(t){n.push(t);let e=sA.Yi(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.La.p_(n),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",r=>eu.forEach(t,t=>eu.forEach(t.Hi,n=>e.persistence.referenceDelegate.addReference(r,t.targetId,n)).next(()=>eu.forEach(t.Ji,n=>e.persistence.referenceDelegate.removeReference(r,t.targetId,n)))))}catch(e){if(!ep(e))throw e;T(sO,"Failed to update sequence numbers: "+e)}for(let r of t){let t=r.targetId;if(!r.fromCache){let r=e.Ts.get(t),n=r.snapshotVersion,i=r.withLastLimboFreeSnapshotVersion(n);e.Ts=e.Ts.insert(t,i)}}}(e.localStore,i))}async function oS(e,t){if(!e.currentUser.isEqual(t)){T(or,"User change. New user:",t.toKey());let r=await sL(e.localStore,t);e.currentUser=t,e.Ga.forEach(e=>{e.forEach(e=>{e.reject(new N(x.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.Ga.clear(),e.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await o_(e,r.Rs)}}function ox(e,t){let r=e.Ua.get(t);if(r&&r.Ba)return r9().add(r.key);{let r=r9(),n=e.qa.get(t);if(!n)return r;for(let t of n){let n=e.ka.get(t);r=r.unionWith(n.view.Sa)}return r}}async function oN(e,t){let r=await sB(e.localStore,t.query,!0),n=t.view.Oa(r);return e.isPrimaryClient&&oE(e,t.targetId,n.Ma),n}async function oD(e,t){return sK(e.localStore,t).then(t=>o_(e,t))}async function ok(e,t,r,n){var i;let s=await function(e,t){let r=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",n=>r.Ln(n,t).next(t=>t?e.localDocuments.getDocuments(n,t):eu.resolve(null)))}(e.localStore,t);null!==s?("pending"===r?await aL(e.remoteStore):"acknowledged"===r||"rejected"===r?(ov(e,t,n||null),ow(e,t),i=e.localStore,i.mutationQueue.qn(t)):S(),await o_(e,s)):T(or,"Cannot apply mutation batch with id: "+t)}async function oC(e,t){if(oL(e),oF(e),!0===t&&!0!==e.ja){let t=e.sharedClientState.getAllActiveQueryTargets(),r=await oA(e,t.toArray());for(let t of(e.ja=!0,await a$(e.remoteStore,!0),r))ab(e.remoteStore,t)}else if(!1===t&&!1!==e.ja){let t=[],r=Promise.resolve();e.qa.forEach((n,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):r=r.then(()=>(oI(e,i),sq(e.localStore,i,!0))),a_(e.remoteStore,i)}),await r,await oA(e,t),e.Ua.forEach((t,r)=>{a_(e.remoteStore,r)}),e.Ka.Dr(),e.Ua=new Map,e.$a=new tS(Y.comparator),e.ja=!1,await a$(e.remoteStore,!1)}}async function oA(e,t,r){let n=[],i=[];for(let r of t){let t,s=e.qa.get(r);if(s&&0!==s.length)for(let r of(t=await sU(e.localStore,r$(s[0])),s)){let t=e.ka.get(r),n=await oN(e,t);n.snapshot&&i.push(n.snapshot)}else{let n=await sz(e.localStore,r);t=await sU(e.localStore,n),await ou(e,oV(n),r,!1,t.resumeToken)}n.push(t)}return e.La.p_(i),n}function oV(e){var t,r,n,i,s;return t=e.path,r=e.collectionGroup,n=e.orderBy,i=e.filters,s=e.limit,new rU(t,r,n,i,s,"F",e.startAt,e.endAt)}function oR(e){return e.localStore.persistence.zi()}async function oO(e,t,r,n){if(e.ja)return void T(or,"Ignoring unexpected query state notification.");let i=e.qa.get(t);if(i&&i.length>0)switch(r){case"current":case"not-current":{let n=await sK(e.localStore,rJ(i[0])),s=nU.createSynthesizedRemoteEventForCurrentChange(t,"current"===r,tR.EMPTY_BYTE_STRING);await o_(e,n,s);break}case"rejected":await sq(e.localStore,t,!0),oI(e,t,n);break;default:S()}}async function oM(e,t,r){let n=oL(e);if(n.ja){for(let e of t){if(n.qa.has(e)&&n.sharedClientState.isActiveQueryTarget(e)){T(or,"Adding an already active target "+e);continue}let t=await sz(n.localStore,e),r=await sU(n.localStore,t);await ou(n,oV(t),r.targetId,!1,r.resumeToken),ab(n.remoteStore,r)}for(let e of r)n.qa.has(e)&&await sq(n.localStore,e,!1).then(()=>{a_(n.remoteStore,e),oI(n,e)}).catch(el)}}function oL(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=of.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=ox.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=og.bind(null,e),e.La.p_=a5.bind(null,e.eventManager),e.La.Ja=a8.bind(null,e.eventManager),e}function oF(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=op.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=oy.bind(null,e),e}class oP{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=ah(e.databaseInfo.databaseId),this.sharedClientState=this.Za(e),this.persistence=this.Xa(e),await this.persistence.start(),this.localStore=this.eu(e),this.gcScheduler=this.tu(e,this.localStore),this.indexBackfillerScheduler=this.nu(e,this.localStore)}tu(e,t){return null}nu(e,t){return null}eu(e){var t,r;return t=this.persistence,r=new sR,new sM(t,r,e.initialUser,this.serializer)}Xa(e){return new sT(sb.ri,this.serializer)}Za(e){return new s4}async terminate(){var e,t;null==(e=this.gcScheduler)||e.stop(),null==(t=this.indexBackfillerScheduler)||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}oP.provider={build:()=>new oP};class oU extends oP{constructor(e){super(),this.cacheSizeBytes=e}tu(e,t){return this.persistence.referenceDelegate instanceof s_||S(),new se(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Xa(e){let t=void 0!==this.cacheSizeBytes?iJ.withCacheSize(this.cacheSizeBytes):iJ.DEFAULT;return new sT(e=>s_.ri(e,t),this.serializer)}}class oq extends oP{constructor(e,t,r){super(),this.ru=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.ru.initialize(this,e),await oF(this.ru.syncEngine),await aL(this.ru.remoteStore),await this.persistence.Ci(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}eu(e){var t,r;return t=this.persistence,r=new sR,new sM(t,r,e.initialUser,this.serializer)}tu(e,t){return new se(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}nu(e,t){let r=new eb(t,this.persistence);return new eE(e.asyncQueue,r)}Xa(e){let t=sC(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=void 0!==this.cacheSizeBytes?iJ.withCacheSize(this.cacheSizeBytes):iJ.DEFAULT;return new sk(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,al(),au(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Za(e){return new s4}}class oB extends oq{constructor(e,t){super(e,t,!1),this.ru=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.ru.syncEngine;this.sharedClientState instanceof s3&&(this.sharedClientState.syncEngine={uo:ok.bind(null,t),co:oO.bind(null,t),lo:oM.bind(null,t),zi:oR.bind(null,t),ao:oD.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ci(async e=>{await oC(this.ru.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Za(e){let t=al();if(!s3.D(t))throw new N(x.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=sC(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new s3(t,e.asyncQueue,r,e.clientId,e.initialUser)}}class oz{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>om(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=oS.bind(null,this.syncEngine),await a$(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new aX}createDatastore(e){var t;let r=ah(e.databaseInfo.databaseId),n=new ao(e.databaseInfo);return t=e.authCredentials,new ay(t,e.appCheckCredentials,n,r)}createRemoteStore(e){var t,r;return t=this.localStore,r=this.datastore,new aI(t,r,e.asyncQueue,e=>om(this.syncEngine,e,0),s7.D()?new s7:new s6)}createSyncEngine(e,t){return function(e,t,r,n,i,s,a){let o=new os(e,t,r,n,i,s);return a&&(o.ja=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){T(av,"RemoteStore shutting down."),e.W_.add(5),await aE(e),e.z_.shutdown(),e.j_.set("Unknown")}(this.remoteStore),null==(e=this.datastore)||e.terminate(),null==(t=this.eventManager)||t.terminate()}}oz.provider={build:()=>new oz};class oK{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.iu(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.iu(this.observer.error,e):E("Uncaught Error in snapshot listener:",e.toString()))}su(){this.muted=!0}iu(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class o${constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new N(x.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let r={documents:t.map(t=>n3(e.serializer,t))},n=await e.Co("BatchGetDocuments",e.serializer.databaseId,Q.emptyPath(),r,t.length),i=new Map;n.forEach(t=>{var r;let n=(r=e.serializer,"found"in t?function(e,t){t.found||S(),t.found.name,t.found.updateTime;let r=n4(e,t.found.name),n=n1(t.found.updateTime),i=t.found.createTime?n1(t.found.createTime):$.min(),s=new ru({mapValue:{fields:t.found.fields}});return rh.newFoundDocument(r,n,i,s)}(r,t):"missing"in t?function(e,t){t.missing||S(),t.readTime||S();let r=n4(e,t.missing),n=n1(t.readTime);return rh.newNoDocument(r,n)}(r,t):S());i.set(n.key.toString(),n)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());t||S(),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new nx(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let r=Y.fromPath(t);this.mutations.push(new nN(r,this.precondition(r)))}),await async function(e,t){let r={writes:t.map(t=>ii(e.serializer,t))};await e.So("Commit",e.serializer.databaseId,Q.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw S();t=$.min()}let r=this.readVersions.get(e.key.toString());if(r){if(!t.isEqual(r))throw new N(x.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual($.min())?ng.exists(!1):ng.updateTime(t):ng.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual($.min()))throw new N(x.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return ng.updateTime(t)}return ng.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}let oG="FirestoreClient";class oj{constructor(e,t,r,n,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=n,this.user=y.UNAUTHENTICATED,this.clientId=P.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(r,async e=>{T(oG,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(r,e=>(T(oG,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new D;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(r){let t=aH(r,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function oQ(e,t){e.asyncQueue.verifyOperationInProgress(),T(oG,"Initializing OfflineComponentProvider");let r=e.configuration;await t.initialize(r);let n=r.initialUser;e.setCredentialChangeListener(async e=>{n.isEqual(e)||(await sL(t.localStore,e),n=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function oH(e,t){e.asyncQueue.verifyOperationInProgress();let r=await oW(e);T(oG,"Initializing OnlineComponentProvider"),await t.initialize(r,e.configuration),e.setCredentialChangeListener(e=>aK(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,r)=>aK(t.remoteStore,r)),e._onlineComponents=t}async function oW(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){T(oG,"Using user provided OfflineComponentProvider");try{await oQ(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===x.FAILED_PRECONDITION||t.code===x.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;b("Error using user provided cache. Falling back to memory cache: "+t),await oQ(e,new oP)}}else T(oG,"Using default OfflineComponentProvider"),await oQ(e,new oU(void 0));return e._offlineComponents}async function oY(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(T(oG,"Using user provided OnlineComponentProvider"),await oH(e,e._uninitializedComponentsProvider._online)):(T(oG,"Using default OnlineComponentProvider"),await oH(e,new oz))),e._onlineComponents}async function oZ(e){let t=await oY(e),r=t.eventManager;return r.onListen=oa.bind(null,t.syncEngine),r.onUnlisten=oh.bind(null,t.syncEngine),r.onFirstRemoteStoreListen=oo.bind(null,t.syncEngine),r.onLastRemoteStoreUnlisten=oc.bind(null,t.syncEngine),r}function oJ(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let oX=new Map;function o0(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let r=(t=e).constructor?t.constructor.name:null;return r?`a custom ${r} object`:"an object"}}return"function"==typeof e?"a function":S()}function o1(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new N(x.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let r=o0(e);throw new N(x.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${r}`)}}return e}let o2="firestore.googleapis.com";class o5{constructor(e){var t,r;if(void 0===e.host){if(void 0!==e.ssl)throw new N(x.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=o2,this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new N(x.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,r,n){if(!0===t&&!0===n)throw new N(x.INVALID_ARGUMENT,`${e} and ${r} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=oJ(null!=(r=e.experimentalLongPollingOptions)?r:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new N(x.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new N(x.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new N(x.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,r;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,r=e.experimentalLongPollingOptions,t.timeoutSeconds===r.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class o8{constructor(e,t,r,n){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new o5({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new N(x.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new N(x.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new o5(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new C;switch(e.type){case"firstParty":return new O(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new N(x.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=oX.get(e);t&&(T("ComponentProvider","Removing Datastore"),oX.delete(e),t.terminate())}(this),Promise.resolve()}}class o3{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new o3(this.firestore,e,this._query)}}class o4{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new o6(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new o4(this.firestore,e,this._key)}}class o6 extends o3{constructor(e,t,r){super(e,t,rq(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new o4(this.firestore,null,new Y(e))}withConverter(e){return new o6(this.firestore,e,this._path)}}let o9="AsyncQueue";class o7{constructor(e=Promise.resolve()){this.Vu=[],this.mu=!1,this.fu=[],this.gu=null,this.pu=!1,this.yu=!1,this.wu=[],this.a_=new ac(this,"async_queue_retry"),this.Su=()=>{let e=au();e&&T(o9,"Visibility state changed to "+e.visibilityState),this.a_.t_()},this.bu=e;let t=au();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Su)}get isShuttingDown(){return this.mu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Du(),this.vu(e)}enterRestrictedMode(e){if(!this.mu){this.mu=!0,this.yu=e||!1;let t=au();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Su)}}enqueue(e){if(this.Du(),this.mu)return new Promise(()=>{});let t=new D;return this.vu(()=>this.mu&&this.yu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Vu.push(e),this.Cu()))}async Cu(){if(0!==this.Vu.length){try{await this.Vu[0](),this.Vu.shift(),this.a_.reset()}catch(e){if(!ep(e))throw e;T(o9,"Operation failed with retryable error: "+e)}this.Vu.length>0&&this.a_.Xo(()=>this.Cu())}}vu(e){let t=this.bu.then(()=>(this.pu=!0,e().catch(e=>{let t;throw this.gu=e,this.pu=!1,E("INTERNAL UNHANDLED ERROR: ",(t=e.message||"",e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t)),e}).then(e=>(this.pu=!1,e))));return this.bu=t,t}enqueueAfterDelay(e,t,r){this.Du(),this.wu.indexOf(e)>-1&&(t=0);let n=aQ.createAndSchedule(this,e,t,r,e=>this.Fu(e));return this.fu.push(n),n}Du(){this.gu&&S()}verifyOperationInProgress(){}async Mu(){let e;do e=this.bu,await e;while(e!==this.bu)}xu(e){for(let t of this.fu)if(t.timerId===e)return!0;return!1}Ou(e){return this.Mu().then(()=>{for(let t of(this.fu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.fu))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Mu()})}Nu(e){this.wu.push(e)}Fu(e){let t=this.fu.indexOf(e);this.fu.splice(t,1)}}class le extends o8{constructor(e,t,r,n){super(e,t,r,n),this.type="firestore",this._queue=new o7,this._persistenceKey=(null==n?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new o7(e),this._firestoreClient=void 0,await e}}}function lt(e,t){let r="object"==typeof e?e:(0,o.Sx)(),n=(0,o.j6)(r,"firestore").getImmediate({identifier:"string"==typeof e?e:t||tj});if(!n._initialized){let e=(0,h.yU)("firestore");e&&function(e,t,r,n={}){var i;let s=(e=o1(e,o8))._getSettings(),a=Object.assign(Object.assign({},s),{emulatorOptions:e._getEmulatorOptions()}),o=`${t}:${r}`;s.host!==o2&&s.host!==o&&b("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let l=Object.assign(Object.assign({},s),{host:o,ssl:!1,emulatorOptions:n});if(!(0,h.bD)(l,a)&&(e._setSettings(l),n.mockUserToken)){let t,r;if("string"==typeof n.mockUserToken)t=n.mockUserToken,r=y.MOCK_USER;else{t=(0,h.Fy)(n.mockUserToken,null==(i=e._app)?void 0:i.options.projectId);let s=n.mockUserToken.sub||n.mockUserToken.user_id;if(!s)throw new N(x.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");r=new y(s)}e._authCredentials=new A(new k(t,r))}}(n,...e)}return n}function lr(e){if(e._terminated)throw new N(x.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||ln(e),e._firestoreClient}function ln(e){var t,r,n,i,s;let a=e._freezeSettings(),o=(i=e._databaseId,s=(null==(t=e._app)?void 0:t.options.appId)||"",new tG(i,s,e._persistenceKey,a.host,a.ssl,a.experimentalForceLongPolling,a.experimentalAutoDetectLongPolling,oJ(a.experimentalLongPollingOptions),a.useFetchStreams));e._componentsProvider||(null==(r=a.localCache)?void 0:r._offlineComponentProvider)&&(null==(n=a.localCache)?void 0:n._onlineComponentProvider)&&(e._componentsProvider={_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider}),e._firestoreClient=new oj(e._authCredentials,e._appCheckCredentials,e._queue,o,e._componentsProvider&&function(e){let t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}class li{constructor(e){this._byteString=e}static fromBase64String(e){try{return new li(tR.fromBase64String(e))}catch(e){throw new N(x.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new li(tR.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class ls{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new N(x.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class la{constructor(e){this._methodName=e}}class lo{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new N(x.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new N(x.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return U(this._lat,e._lat)||U(this._long,e._long)}}class ll{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}(this._values,e._values)}}let lu=/^__.*__$/;class lh{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return null!==this.fieldMask?new nE(e,this.data,this.fieldMask,t,this.fieldTransforms):new nT(e,this.data,t,this.fieldTransforms)}}class lc{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new nE(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function ld(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw S()}}class lf{constructor(e,t,r,n,i,s){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=n,void 0===i&&this.Bu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Lu(){return this.settings.Lu}ku(e){return new lf(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}qu(e){var t;let r=null==(t=this.path)?void 0:t.child(e),n=this.ku({path:r,Qu:!1});return n.$u(e),n}Uu(e){var t;let r=null==(t=this.path)?void 0:t.child(e),n=this.ku({path:r,Qu:!1});return n.Bu(),n}Ku(e){return this.ku({path:void 0,Qu:!0})}Wu(e){return lR(e,this.settings.methodName,this.settings.Gu||!1,this.path,this.settings.zu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Bu(){if(this.path)for(let e=0;e<this.path.length;e++)this.$u(this.path.get(e))}$u(e){if(0===e.length)throw this.Wu("Document fields must not be empty");if(ld(this.Lu)&&lu.test(e))throw this.Wu('Document fields cannot begin and end with "__"')}}class lm{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||ah(e)}ju(e,t,r,n=!1){return new lf({Lu:e,methodName:t,zu:r,path:W.emptyPath(),Qu:!1,Gu:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function lg(e){let t=e._freezeSettings(),r=ah(e._databaseId);return new lm(e._databaseId,!!t.ignoreUndefinedProperties,r)}function lp(e,t,r,n,i,s={}){let a,o,l=e.ju(s.merge||s.mergeFields?2:0,t,r,i);lk("Data must be an object, but it was:",l,n);let u=lN(n,l);if(s.merge)a=new tA(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let n of s.mergeFields){let i=lC(t,n,r);if(!l.contains(i))throw new N(x.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);lO(e,i)||e.push(i)}a=new tA(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new lh(new ru(u),a,o)}class ly extends la{_toFieldTransform(e){if(2!==e.Lu)throw 1===e.Lu?e.Wu(`${this._methodName}() can only appear at the top level of your update data`):e.Wu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof ly}}function lw(e,t,r){return new lf({Lu:3,zu:t.settings.zu,methodName:e._methodName,Qu:r},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class lv extends null{_toFieldTransform(e){return new nf(e.path,new ns)}isEqual(e){return e instanceof lv}}class lI extends la{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=lw(this,e,!0),r=new na(this.Hu.map(e=>lx(e,t)));return new nf(e.path,r)}isEqual(e){return e instanceof lI&&(0,h.bD)(this.Hu,e.Hu)}}class lT extends la{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=lw(this,e,!0),r=new nl(this.Hu.map(e=>lx(e,t)));return new nf(e.path,r)}isEqual(e){return e instanceof lT&&(0,h.bD)(this.Hu,e.Hu)}}class lE extends la{constructor(e,t){super(e),this.Ju=t}_toFieldTransform(e){let t=new nh(e.serializer,nr(e.serializer,this.Ju));return new nf(e.path,t)}isEqual(e){return e instanceof lE&&this.Ju===e.Ju}}function lb(e,t,r,n){let i=e.ju(1,t,r);lk("Data must be an object, but it was:",i,n);let s=[],a=ru.empty();return tb(n,(e,n)=>{let o=lV(t,e,r);n=(0,h.Ku)(n);let l=i.Uu(o);if(n instanceof ly)s.push(o);else{let e=lx(n,l);null!=e&&(s.push(o),a.set(o,e))}}),new lc(a,new tA(s),i.fieldTransforms)}function l_(e,t,r,n,i,s){let a=e.ju(1,t,r),o=[lC(t,n,r)],l=[i];if(s.length%2!=0)throw new N(x.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(lC(t,s[e])),l.push(s[e+1]);let u=[],c=ru.empty();for(let e=o.length-1;e>=0;--e)if(!lO(u,o[e])){let t=o[e],r=l[e];r=(0,h.Ku)(r);let n=a.Uu(t);if(r instanceof ly)u.push(t);else{let e=lx(r,n);null!=e&&(u.push(t),c.set(t,e))}}return new lc(c,new tA(u),a.fieldTransforms)}function lS(e,t,r,n=!1){return lx(r,e.ju(n?4:3,t))}function lx(e,t){if(lD(e=(0,h.Ku)(e)))return lk("Unsupported field value:",t,e),lN(e,t);if(e instanceof la)return function(e,t){if(!ld(t.Lu))throw t.Wu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Wu(`${e._methodName}() is not currently supported inside arrays`);let r=e._toFieldTransform(t);r&&t.fieldTransforms.push(r)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Qu&&4!==t.Lu)throw t.Wu("Nested arrays are not supported");let r=[],n=0;for(let i of e){let e=lx(i,t.Ku(n));null==e&&(e={nullValue:"NULL_VALUE"}),r.push(e),n++}return{arrayValue:{values:r}}}return function(e,t){if(null===(e=(0,h.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return nr(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let r=K.fromDate(e);return{timestampValue:nX(t.serializer,r)}}if(e instanceof K){let r=new K(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:nX(t.serializer,r)}}if(e instanceof lo)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof li)return{bytesValue:n0(t.serializer,e._byteString)};if(e instanceof o4){let r=t.databaseId,n=e.firestore._databaseId;if(!n.isEqual(r))throw t.Wu(`Document reference is for database ${n.projectId}/${n.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:n2(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof ll)return{mapValue:{fields:{[tH]:{stringValue:tZ},[tJ]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Wu("VectorValues must only contain numeric values.");return ne(t.serializer,e)})}}}}};throw t.Wu(`Unsupported field value: ${o0(e)}`)}(e,t)}function lN(e,t){let r={};return t_(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tb(e,(e,n)=>{let i=lx(n,t.qu(e));null!=i&&(r[e]=i)}),{mapValue:{fields:r}}}function lD(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof K||e instanceof lo||e instanceof li||e instanceof o4||e instanceof la||e instanceof ll)}function lk(e,t,r){if(!lD(r)||"object"!=typeof r||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r)){let n=o0(r);throw"an object"===n?t.Wu(e+" a custom object"):t.Wu(e+" "+n)}}function lC(e,t,r){if((t=(0,h.Ku)(t))instanceof ls)return t._internalPath;if("string"==typeof t)return lV(e,t);throw lR("Field path arguments must be of type string or ",e,!1,void 0,r)}let lA=RegExp("[~\\*/\\[\\]]");function lV(e,t,r){if(t.search(lA)>=0)throw lR(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,r);try{return new ls(...t.split("."))._internalPath}catch(n){throw lR(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,r)}}function lR(e,t,r,n,i){let s=n&&!n.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;r&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${n}`),a&&(l+=` in document ${i}`),l+=")"),new N(x.INVALID_ARGUMENT,o+e+l)}function lO(e,t){return e.some(e=>e.isEqual(t))}class lM{constructor(e,t,r,n,i){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=n,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new o4(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new lL(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(lF("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class lL extends lM{data(){return super.data()}}function lF(e,t){return"string"==typeof t?lV(e,t):t instanceof ls?t._internalPath:t._delegate._internalPath}class lP{}class lU extends lP{}class lq extends lU{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new lq(e,t,r)}_apply(e){let t=this._parse(e);return lW(e._query,t),new o3(e.firestore,e.converter,rj(e._query,t))}_parse(e){let t=lg(e.firestore);return function(e,t,r,n,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new N(x.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){lH(a,s);let t=[];for(let r of a)t.push(lQ(n,e,r));o={arrayValue:{values:t}}}else o=lQ(n,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||lH(a,s),o=lS(r,t,a,"in"===s||"not-in"===s);return rp.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class lB extends lP{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new lB(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:ry.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let r=e;for(let e of t.getFlattenedFilters())lW(r,e),r=rj(r,e)}(e._query,t),new o3(e.firestore,e.converter,rj(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class lz extends lU{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new lz(e,t)}_apply(e){let t=function(e,t,r){if(null!==e.startAt)throw new N(x.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new N(x.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new rm(t,r)}(e._query,this._field,this._direction);return new o3(e.firestore,e.converter,function(e,t){let r=e.explicitOrderBy.concat([t]);return new rU(e.path,e.collectionGroup,r,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class lK extends lU{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new lK(e,t,r)}_apply(e){return new o3(e.firestore,e.converter,rQ(e._query,this._limit,this._limitType))}}class l$ extends lU{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new l$(e,t,r)}_apply(e){var t;let r=lj(e,this.type,this._docOrFields,this._inclusive);return new o3(e.firestore,e.converter,(t=e._query,new rU(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,r,t.endAt)))}}class lG extends lU{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new lG(e,t,r)}_apply(e){var t;let r=lj(e,this.type,this._docOrFields,this._inclusive);return new o3(e.firestore,e.converter,(t=e._query,new rU(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,r)))}}function lj(e,t,r,n){if(r[0]=(0,h.Ku)(r[0]),r[0]instanceof lM)return function(e,t,r,n,i){if(!n)throw new N(x.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${r}().`);let s=[];for(let r of rK(e))if(r.field.isKeyField())s.push(t6(t,n.key));else{let e=n.data.field(r.field);if(tz(e))throw new N(x.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+r.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=r.field.canonicalString();throw new N(x.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new rc(s,i)}(e._query,e.firestore._databaseId,t,r[0]._document,n);{let i=lg(e.firestore);return function(e,t,r,n,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new N(x.INVALID_ARGUMENT,`Too many arguments provided to ${n}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new N(x.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${n}(), but got a ${typeof l}`);if(!rz(e)&&-1!==l.indexOf("/"))throw new N(x.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${n}() must be a plain document ID, but '${l}' contains a slash.`);let r=e.path.child(Q.fromString(l));if(!Y.isDocumentKey(r))throw new N(x.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${n}() must result in a valid document path, but '${r}' is not because it contains an odd number of segments.`);let i=new Y(r);o.push(t6(t,i))}else{let e=lS(r,n,l);o.push(e)}}return new rc(o,s)}(e._query,e.firestore._databaseId,i,t,r,n)}}function lQ(e,t,r){if("string"==typeof(r=(0,h.Ku)(r))){if(""===r)throw new N(x.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!rz(t)&&-1!==r.indexOf("/"))throw new N(x.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${r}' contains a '/' character.`);let n=t.path.child(Q.fromString(r));if(!Y.isDocumentKey(n))throw new N(x.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${n}' is not because it has an odd number of segments (${n.length}).`);return t6(e,new Y(n))}if(r instanceof o4)return t6(e,r._key);throw new N(x.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${o0(r)}.`)}function lH(e,t){if(!Array.isArray(e)||0===e.length)throw new N(x.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function lW(e,t){let r=function(e,t){for(let r of e)for(let e of r.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==r)throw r===t.op?new N(x.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new N(x.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}class lY{convertValue(e,t="none"){switch(t0(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tL(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(tF(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw S()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return tb(e,(e,n)=>{r[e]=this.convertValue(n,t)}),r}convertVectorValue(e){var t,r,n;return new ll(null==(n=null==(r=null==(t=e.fields)?void 0:t[tJ].arrayValue)?void 0:r.values)?void 0:n.map(e=>tL(e.doubleValue)))}convertGeoPoint(e){return new lo(tL(e.latitude),tL(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=tK(e);return null==r?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(t$(e));default:return null}}convertTimestamp(e){let t=tM(e);return new K(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=Q.fromString(e);ic(r)||S();let n=new tQ(r.get(1),r.get(3)),i=new Y(r.popFirst(5));return n.isEqual(t)||E(`Document ${i} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function lZ(e,t,r){return e?r&&(r.merge||r.mergeFields)?e.toFirestore(t,r):e.toFirestore(t):t}class lJ extends lY{constructor(e){super(),this.firestore=e}convertBytes(e){return new li(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new o4(this.firestore,null,t)}}class lX{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class l0 extends lM{constructor(e,t,r,n,i,s){super(e,t,r,n,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new l1(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(lF("DocumentSnapshot.get",e));if(null!==r)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}}class l1 extends l0{data(e={}){return super.data(e)}}class l2 extends lY{constructor(e){super(),this.firestore=e}convertBytes(e){return new li(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new o4(this.firestore,null,t)}}class l5{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=oz.provider,this._offlineComponentProvider={build:t=>new oq(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}function l8(e,t){if((e=(0,h.Ku)(e)).firestore!==t)throw new N(x.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class l3{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=lg(e)}get(e){let t=l8(e,this._firestore),r=new lJ(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return S();let n=e[0];if(n.isFoundDocument())return new lM(this._firestore,r,n.key,n,t.converter);if(n.isNoDocument())return new lM(this._firestore,r,t._key,null,t.converter);throw S()})}set(e,t,r){let n=l8(e,this._firestore),i=lZ(n.converter,t,r),s=lp(this._dataReader,"Transaction.set",n._key,i,null!==n.converter,r);return this._transaction.set(n._key,s),this}update(e,t,r,...n){let i,s=l8(e,this._firestore);return i="string"==typeof(t=(0,h.Ku)(t))||t instanceof ls?l_(this._dataReader,"Transaction.update",s._key,t,r,n):lb(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=l8(e,this._firestore);return this._transaction.delete(t._key),this}}new WeakMap,!function(e,t=!0){w=o.MF,(0,o.om)(new l.uA("firestore",(e,{instanceIdentifier:r,options:n})=>{let i=e.getProvider("app").getImmediate(),s=new le(new V(e.getProvider("auth-internal")),new L(i,e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new N(x.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new tQ(e.options.projectId,t)}(i,r),i);return n=Object.assign({useFetchStreams:t},n),s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,p,void 0),(0,o.KO)(g,p,"esm2017")}()}}]);